System.register(['./Pattern', 'q', 'oidc-client'], function(exports_1, context_1) {
    "use strict";
    var __moduleName = context_1 && context_1.id;
    var Pattern_1, Q, Oidc;
    var AuthenticationContext;
    return {
        setters:[
            function (Pattern_1_1) {
                Pattern_1 = Pattern_1_1;
            },
            function (Q_1) {
                Q = Q_1;
            },
            function (Oidc_1) {
                Oidc = Oidc_1;
            }],
        execute: function() {
            AuthenticationContext = (function () {
                function AuthenticationContext() {
                    this.callbacksTokenObtained = new Array();
                    this.callbacksTokenRenewFailedRetryMax = new Array();
                    var authenticationSettingsLoadedFromStorage = this.AuthenticationManagerSettings;
                    if (authenticationSettingsLoadedFromStorage != null) {
                        this.oidcTokenManager = new Oidc.UserManager(authenticationSettingsLoadedFromStorage);
                    }
                }
                Object.defineProperty(AuthenticationContext, "Current", {
                    get: function () {
                        if (AuthenticationContext._current === null) {
                            AuthenticationContext._current = new AuthenticationContext();
                        }
                        return AuthenticationContext._current;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(AuthenticationContext.prototype, "IsInitialized", {
                    get: function () {
                        if (this.AuthenticationManagerSettings != null) {
                            return true;
                        }
                        else {
                            return false;
                        }
                    },
                    enumerable: true,
                    configurable: true
                });
                AuthenticationContext.Reset = function () {
                    AuthenticationContext._current = null;
                };
                AuthenticationContext.prototype.AddOnTokenObtained = function (callback) {
                    this.callbacksTokenObtained.push(callback);
                    this.oidcTokenManager.events.addUserLoaded(callback);
                };
                AuthenticationContext.prototype.AddOnTokenRenewFailedMaxRetry = function (callback) {
                    this.callbacksTokenRenewFailedRetryMax.push(callback);
                };
                Object.defineProperty(AuthenticationContext.prototype, "AuthenticationManagerSettings", {
                    get: function () {
                        var authenticationSettingsFromLocalStorage = null;
                        var authenticationSettingsFromLocalStorageStringify = localStorage.getItem('AuthenticationManagerSettings');
                        if (authenticationSettingsFromLocalStorageStringify != null) {
                            authenticationSettingsFromLocalStorage = JSON.parse(authenticationSettingsFromLocalStorageStringify);
                        }
                        return authenticationSettingsFromLocalStorage;
                    },
                    set: function (value) {
                        localStorage.setItem('AuthenticationManagerSettings', JSON.stringify(value));
                    },
                    enumerable: true,
                    configurable: true
                });
                AuthenticationContext.prototype.Initialize = function (authenticationSettings) {
                    if (authenticationSettings.authority == null || authenticationSettings.client_id == null || authenticationSettings.client_url == null) {
                        throw "Should be informed at least 'authority', 'client_id' and 'client_url'!";
                    }
                    if (authenticationSettings.pattern == null) {
                        authenticationSettings.pattern = Pattern_1.Pattern.none;
                    }
                    if (authenticationSettings.pattern == Pattern_1.Pattern.ietf) {
                        authenticationSettings.client_url = 'urn:ietf:wg:oauth:2.0:oob:auto';
                    }
                    authenticationSettings.client_url = authenticationSettings.client_url;
                    console.debug('ClientUrl: ' + authenticationSettings.client_url);
                    authenticationSettings.scope = authenticationSettings.scope || 'openid profile email offline_access';
                    authenticationSettings.response_type = authenticationSettings.response_type || 'code id_token token';
                    authenticationSettings.open_on_popup = authenticationSettings.open_on_popup || false;
                    authenticationSettings.max_retry_renew = authenticationSettings.max_retry_renew || 35;
                    console.debug('Max retry setted to: ' + authenticationSettings.max_retry_renew);
                    authenticationSettings.silent_renew_timeout = authenticationSettings.silent_renew_timeout || 40 * 1000;
                    console.debug('Silent renew timeout setted to: ' + authenticationSettings.silent_renew_timeout + ' miliseconds');
                    this.AuthenticationManagerSettings =
                        {
                            authority: authenticationSettings.authority,
                            client_id: authenticationSettings.client_id,
                            client_url: authenticationSettings.client_url,
                            max_retry_renew: authenticationSettings.max_retry_renew,
                            silent_renew_timeout: authenticationSettings.silent_renew_timeout,
                            response_type: authenticationSettings.response_type,
                            scope: authenticationSettings.scope,
                            pattern: authenticationSettings.pattern,
                            redirect_uri: authenticationSettings.client_url,
                            silent_redirect_uri: authenticationSettings.client_url,
                            post_logout_redirect_uri: authenticationSettings.client_url,
                            authorization_url: authenticationSettings.authorization_url || authenticationSettings.authority + "/connect/authorize",
                            token_url: authenticationSettings.token_url || authenticationSettings.authority + "/connect/token",
                            userinfo_url: authenticationSettings.userinfo_url || authenticationSettings.authority + "/connect/userinfo",
                            loadUserInfo: true,
                            automaticSilentRenew: true,
                        };
                    var userManagerSettings = this.AuthenticationManagerSettings;
                    if (this.AuthenticationManagerSettings.pattern == Pattern_1.Pattern.cordova) {
                        console.log('cordova pattern');
                        userManagerSettings.popupNavigator = Oidc.CordovaPopupNavigator();
                        userManagerSettings.iframeNavigator = Oidc.CordovaIFrameNavigator();
                    }
                    this.oidcTokenManager = new Oidc.UserManager(userManagerSettings);
                };
                AuthenticationContext.prototype.ProcessTokenIfNeeded = function () {
                    var _this = this;
                    return this.IsAuthenticated.then(function (isAuthenticated) {
                        if (location.href.indexOf('access_token=') > -1 && (isAuthenticated || location.href.indexOf('prompt=none') > -1)) {
                            console.debug('Processing token! (silently)');
                            return _this.oidcTokenManager.signinSilentCallback();
                        }
                        else if (location.href.indexOf('access_token=') > -1) {
                            console.debug('Processing token!');
                            return _this.ProcessTokenCallback();
                        }
                        var qPromise = Q.resolve(null);
                        return qPromise;
                    });
                };
                AuthenticationContext.prototype.Init = function (authenticationSettings) {
                    if (authenticationSettings != null) {
                        this.Initialize(authenticationSettings);
                    }
                    return this.ProcessTokenIfNeeded();
                };
                AuthenticationContext.prototype.ProcessTokenCallback = function () {
                    var _this = this;
                    this.ValidateInitialization();
                    var promise = null;
                    if (this.AuthenticationManagerSettings.open_on_popup) {
                        promise = this.oidcTokenManager.signinPopupCallback();
                    }
                    else {
                        promise = this.oidcTokenManager.signinRedirectCallback();
                    }
                    var promiseRedirect = promise
                        .then(function () {
                        _this.RedirectToInitialPage(_this.AuthenticationManagerSettings.redirect_uri);
                    }, function (error) {
                        var message = "Problem Getting Token : " + (error.message || error);
                        console.error(message);
                        throw message;
                    });
                    return promiseRedirect;
                };
                AuthenticationContext.prototype.RedirectToInitialPage = function (uri) {
                    location.assign(uri);
                };
                AuthenticationContext.prototype.ValidateInitialization = function () {
                    if (this.AuthenticationManagerSettings == null) {
                        throw "AuthenticationContext uninitialized!";
                    }
                };
                AuthenticationContext.prototype.Login = function (openOnPopUp) {
                    var _this = this;
                    return this.IsAuthenticated.then(function (isAuthenticated) {
                        if (isAuthenticated === false) {
                            _this.ValidateInitialization();
                            var shouldOpenOnPopUp = openOnPopUp || _this.AuthenticationManagerSettings.open_on_popup;
                            if (shouldOpenOnPopUp) {
                                return _this.oidcTokenManager.signinPopup();
                            }
                            else {
                                return _this.oidcTokenManager.signinRedirect();
                            }
                        }
                        else {
                            console.warn('Already authenticated');
                            return _this.oidcTokenManager.getUser().then(function (user) {
                                _this.callbacksTokenObtained.forEach(function (callback) {
                                    callback(user);
                                });
                            });
                        }
                    });
                };
                Object.defineProperty(AuthenticationContext.prototype, "IsAuthenticated", {
                    get: function () {
                        return this.oidcTokenManager.getUser().then(function (user) { return user != null; });
                    },
                    enumerable: true,
                    configurable: true
                });
                AuthenticationContext._current = null;
                return AuthenticationContext;
            }());
            exports_1("AuthenticationContext", AuthenticationContext);
        }
    }
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9BdXRoZW50aWNhdGlvbkNvbnRleHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7WUFZQTtnQkFpREk7b0JBNUNRLDJCQUFzQixHQUFxQyxJQUFJLEtBQUssRUFBNkIsQ0FBQztvQkFFbEcsc0NBQWlDLEdBQXNCLElBQUksS0FBSyxFQUFjLENBQUM7b0JBNENuRixJQUFJLHVDQUF1QyxHQUFHLElBQUksQ0FBQyw2QkFBNkIsQ0FBQztvQkFDakYsRUFBRSxDQUFBLENBQUMsdUNBQXVDLElBQUksSUFBSSxDQUFDLENBQ25ELENBQUM7d0JBQ0csSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBRSx1Q0FBdUMsQ0FBRSxDQUFDO29CQUM1RixDQUFDO2dCQUNMLENBQUM7Z0JBL0NELHNCQUFrQixnQ0FBTzt5QkFBekI7d0JBRUksRUFBRSxDQUFBLENBQUMscUJBQXFCLENBQUMsUUFBUSxLQUFLLElBQUksQ0FBQyxDQUMzQyxDQUFDOzRCQUNHLHFCQUFxQixDQUFDLFFBQVEsR0FBSSxJQUFJLHFCQUFxQixFQUFFLENBQUM7d0JBQ2xFLENBQUM7d0JBQ0QsTUFBTSxDQUFDLHFCQUFxQixDQUFDLFFBQVEsQ0FBQztvQkFDMUMsQ0FBQzs7O21CQUFBO2dCQUVELHNCQUFXLGdEQUFhO3lCQUF4Qjt3QkFFSSxFQUFFLENBQUEsQ0FBQyxJQUFJLENBQUMsNkJBQTZCLElBQUksSUFBSSxDQUFDLENBQzlDLENBQUM7NEJBQ0csTUFBTSxDQUFDLElBQUksQ0FBQzt3QkFDaEIsQ0FBQzt3QkFDRCxJQUFJLENBQ0osQ0FBQzs0QkFDRyxNQUFNLENBQUMsS0FBSyxDQUFDO3dCQUNqQixDQUFDO29CQUNMLENBQUM7OzttQkFBQTtnQkFFYSwyQkFBSyxHQUFuQjtvQkFFSSxxQkFBcUIsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO2dCQUMxQyxDQUFDO2dCQUVNLGtEQUFrQixHQUF6QixVQUEwQixRQUFtQztv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QVEsR0FBMEIsSUFBSSxDQUFDO2dCQXNjMUQsNEJBQUM7WUFBRCxDQXpjQSxBQXljQyxJQUFBO1lBemNELHlEQXljQyxDQUFBIiwiZmlsZSI6InNyYy9BdXRoZW50aWNhdGlvbkNvbnRleHQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJQXV0aGVudGljYXRpb25NYW5hZ2VyU2V0dGluZ3MgfSBmcm9tICcuL0lBdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncyc7XHJcbmltcG9ydCB7IElBdXRoZW50aWNhdGlvblNldHRpbmdzIH0gZnJvbSAnLi9JQXV0aGVudGljYXRpb25TZXR0aW5ncyc7XHJcbmltcG9ydCB7IFBhdHRlcm4gfSBmcm9tICcuL1BhdHRlcm4nO1xyXG5cclxuaW1wb3J0ICogYXMgUSBmcm9tICdxJztcclxuXHJcbmltcG9ydCAqIGFzIE9pZGMgZnJvbSAnb2lkYy1jbGllbnQnO1xyXG5cclxuXHJcbi8qKlxyXG4gKiBBdXRoZW50aWNhdGlvbkluaXRpYWxpemVyXHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgQXV0aGVudGljYXRpb25Db250ZXh0IFxyXG57XHJcbiAgICBcclxuICAgIHByaXZhdGUgc3RhdGljIF9jdXJyZW50OiBBdXRoZW50aWNhdGlvbkNvbnRleHQgPSBudWxsO1xyXG5cclxuICAgIHByaXZhdGUgY2FsbGJhY2tzVG9rZW5PYnRhaW5lZCA6QXJyYXk8KHVzZXI6IE9pZGMuVXNlcikgPT4gdm9pZD4gPSBuZXcgQXJyYXk8KHVzZXI6IE9pZGMuVXNlcikgPT4gdm9pZD4oKTtcclxuXHJcbiAgICBwcml2YXRlIGNhbGxiYWNrc1Rva2VuUmVuZXdGYWlsZWRSZXRyeU1heCA6QXJyYXk8KCkgPT4gdm9pZD4gPSBuZXcgQXJyYXk8KCkgPT4gdm9pZD4oKTtcclxuXHJcbiAgICBwdWJsaWMgc3RhdGljIGdldCBDdXJyZW50KCk6IEF1dGhlbnRpY2F0aW9uQ29udGV4dCBcclxuICAgIHtcclxuICAgICAgICBpZihBdXRoZW50aWNhdGlvbkNvbnRleHQuX2N1cnJlbnQgPT09IG51bGwpXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBBdXRoZW50aWNhdGlvbkNvbnRleHQuX2N1cnJlbnQgPSAgbmV3IEF1dGhlbnRpY2F0aW9uQ29udGV4dCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gQXV0aGVudGljYXRpb25Db250ZXh0Ll9jdXJyZW50O1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBwdWJsaWMgZ2V0IElzSW5pdGlhbGl6ZWQoKVxyXG4gICAge1xyXG4gICAgICAgIGlmKHRoaXMuQXV0aGVudGljYXRpb25NYW5hZ2VyU2V0dGluZ3MgIT0gbnVsbClcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgXHJcbiAgICBwdWJsaWMgc3RhdGljIFJlc2V0KClcclxuICAgIHtcclxuICAgICAgICBBdXRoZW50aWNhdGlvbkNvbnRleHQuX2N1cnJlbnQgPSBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBBZGRPblRva2VuT2J0YWluZWQoY2FsbGJhY2s6ICh1c2VyOiBPaWRjLlVzZXIpID0+IHZvaWQpXHJcbiAgICB7XHJcbiAgICAgICAgdGhpcy5jYWxsYmFja3NUb2tlbk9idGFpbmVkLnB1c2goY2FsbGJhY2spO1xyXG4gICAgICAgIHRoaXMub2lkY1Rva2VuTWFuYWdlci5ldmVudHMuYWRkVXNlckxvYWRlZChjYWxsYmFjayk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIEFkZE9uVG9rZW5SZW5ld0ZhaWxlZE1heFJldHJ5KGNhbGxiYWNrOiAoKSA9PiB2b2lkKVxyXG4gICAge1xyXG4gICAgICAgIHRoaXMuY2FsbGJhY2tzVG9rZW5SZW5ld0ZhaWxlZFJldHJ5TWF4LnB1c2goY2FsbGJhY2spO1xyXG4gICAgICAgIC8vdGhpcy5vaWRjVG9rZW5NYW5hZ2VyLmFkZE9uU2lsZW50VG9rZW5SZW5ld0ZhaWxlZChjYWxsYmFjayk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBvaWRjVG9rZW5NYW5hZ2VyOiBPaWRjLlVzZXJNYW5hZ2VyO1xyXG4gICAgICAgIFxyXG4gICAgY29uc3RydWN0b3IoKSBcclxuICAgIHtcclxuICAgICAgICBsZXQgYXV0aGVudGljYXRpb25TZXR0aW5nc0xvYWRlZEZyb21TdG9yYWdlID0gdGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncztcclxuICAgICAgICBpZihhdXRoZW50aWNhdGlvblNldHRpbmdzTG9hZGVkRnJvbVN0b3JhZ2UgIT0gbnVsbClcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHRoaXMub2lkY1Rva2VuTWFuYWdlciA9IG5ldyBPaWRjLlVzZXJNYW5hZ2VyKCBhdXRoZW50aWNhdGlvblNldHRpbmdzTG9hZGVkRnJvbVN0b3JhZ2UgKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBcclxuICAgIHByb3RlY3RlZCBnZXQgQXV0aGVudGljYXRpb25NYW5hZ2VyU2V0dGluZ3MoKTogSUF1dGhlbnRpY2F0aW9uTWFuYWdlclNldHRpbmdzIFxyXG4gICAge1xyXG4gICAgICAgIGxldCBhdXRoZW50aWNhdGlvblNldHRpbmdzRnJvbUxvY2FsU3RvcmFnZTogSUF1dGhlbnRpY2F0aW9uTWFuYWdlclNldHRpbmdzID0gbnVsbDtcclxuICAgICAgICBsZXQgYXV0aGVudGljYXRpb25TZXR0aW5nc0Zyb21Mb2NhbFN0b3JhZ2VTdHJpbmdpZnkgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnQXV0aGVudGljYXRpb25NYW5hZ2VyU2V0dGluZ3MnKTtcclxuICAgICAgICBpZihhdXRoZW50aWNhdGlvblNldHRpbmdzRnJvbUxvY2FsU3RvcmFnZVN0cmluZ2lmeSAhPSBudWxsKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgYXV0aGVudGljYXRpb25TZXR0aW5nc0Zyb21Mb2NhbFN0b3JhZ2UgPSBKU09OLnBhcnNlKGF1dGhlbnRpY2F0aW9uU2V0dGluZ3NGcm9tTG9jYWxTdG9yYWdlU3RyaW5naWZ5KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGF1dGhlbnRpY2F0aW9uU2V0dGluZ3NGcm9tTG9jYWxTdG9yYWdlO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBwcm90ZWN0ZWQgc2V0IEF1dGhlbnRpY2F0aW9uTWFuYWdlclNldHRpbmdzKHZhbHVlOiBJQXV0aGVudGljYXRpb25NYW5hZ2VyU2V0dGluZ3MpXHJcbiAgICB7XHJcbiAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ0F1dGhlbnRpY2F0aW9uTWFuYWdlclNldHRpbmdzJywgSlNPTi5zdHJpbmdpZnkodmFsdWUpKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgcHJvdGVjdGVkIEluaXRpYWxpemUoYXV0aGVudGljYXRpb25TZXR0aW5nczogSUF1dGhlbnRpY2F0aW9uU2V0dGluZ3MpXHJcbiAgICB7XHJcbiAgICAgICAgaWYoYXV0aGVudGljYXRpb25TZXR0aW5ncy5hdXRob3JpdHkgPT0gbnVsbCB8fCBhdXRoZW50aWNhdGlvblNldHRpbmdzLmNsaWVudF9pZCA9PSBudWxsIHx8IGF1dGhlbnRpY2F0aW9uU2V0dGluZ3MuY2xpZW50X3VybCA9PSBudWxsKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgdGhyb3cgXCJTaG91bGQgYmUgaW5mb3JtZWQgYXQgbGVhc3QgJ2F1dGhvcml0eScsICdjbGllbnRfaWQnIGFuZCAnY2xpZW50X3VybCchXCI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGlmKGF1dGhlbnRpY2F0aW9uU2V0dGluZ3MucGF0dGVybiA9PSBudWxsKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgYXV0aGVudGljYXRpb25TZXR0aW5ncy5wYXR0ZXJuID0gUGF0dGVybi5ub25lO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYoYXV0aGVudGljYXRpb25TZXR0aW5ncy5wYXR0ZXJuID09IFBhdHRlcm4uaWV0ZilcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIGF1dGhlbnRpY2F0aW9uU2V0dGluZ3MuY2xpZW50X3VybCA9ICd1cm46aWV0Zjp3ZzpvYXV0aDoyLjA6b29iOmF1dG8nO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICAvL1NldCBkZWZhdWx0IHZhbHVlcyBpZiBub3QgaW5mb3JtZWRcclxuICAgICAgICBhdXRoZW50aWNhdGlvblNldHRpbmdzLmNsaWVudF91cmwgPSBhdXRoZW50aWNhdGlvblNldHRpbmdzLmNsaWVudF91cmw7IC8vU2VsZiB1cmlcclxuICAgICAgICBjb25zb2xlLmRlYnVnKCdDbGllbnRVcmw6ICcgKyBhdXRoZW50aWNhdGlvblNldHRpbmdzLmNsaWVudF91cmwpO1xyXG5cclxuICAgICAgICBhdXRoZW50aWNhdGlvblNldHRpbmdzLnNjb3BlID0gYXV0aGVudGljYXRpb25TZXR0aW5ncy5zY29wZSB8fCAnb3BlbmlkIHByb2ZpbGUgZW1haWwgb2ZmbGluZV9hY2Nlc3MnOyAvL09wZW5JZCBkZWZhdWx0IHNjb3Blc1xyXG4gICAgICAgIGF1dGhlbnRpY2F0aW9uU2V0dGluZ3MucmVzcG9uc2VfdHlwZSA9IGF1dGhlbnRpY2F0aW9uU2V0dGluZ3MucmVzcG9uc2VfdHlwZSB8fCAnY29kZSBpZF90b2tlbiB0b2tlbic7IC8vSHlicmlkIGZsb3cgYXQgZGVmYXVsdFxyXG4gICAgICAgIGF1dGhlbnRpY2F0aW9uU2V0dGluZ3Mub3Blbl9vbl9wb3B1cCA9IGF1dGhlbnRpY2F0aW9uU2V0dGluZ3Mub3Blbl9vbl9wb3B1cCB8fCBmYWxzZTsgLy9SZWRpcmVjdCBmb3IgZGVmYXVsdFxyXG5cclxuICAgICAgICBhdXRoZW50aWNhdGlvblNldHRpbmdzLm1heF9yZXRyeV9yZW5ldyA9IGF1dGhlbnRpY2F0aW9uU2V0dGluZ3MubWF4X3JldHJ5X3JlbmV3IHx8IDM1O1xyXG4gICAgICAgIGNvbnNvbGUuZGVidWcoJ01heCByZXRyeSBzZXR0ZWQgdG86ICcgKyBhdXRoZW50aWNhdGlvblNldHRpbmdzLm1heF9yZXRyeV9yZW5ldyk7XHJcbiAgICAgICAgYXV0aGVudGljYXRpb25TZXR0aW5ncy5zaWxlbnRfcmVuZXdfdGltZW91dCA9IGF1dGhlbnRpY2F0aW9uU2V0dGluZ3Muc2lsZW50X3JlbmV3X3RpbWVvdXQgfHwgNDAgKiAxMDAwOyAvLzQwIHNlY29uZHMgdG8gdGltZW91dFxyXG4gICAgICAgIGNvbnNvbGUuZGVidWcoJ1NpbGVudCByZW5ldyB0aW1lb3V0IHNldHRlZCB0bzogJyArIGF1dGhlbnRpY2F0aW9uU2V0dGluZ3Muc2lsZW50X3JlbmV3X3RpbWVvdXQgKyAnIG1pbGlzZWNvbmRzJyk7XHJcblxyXG4gICAgICAgIC8vQ29udmVydCB0byB0aGUgbW9yZSBjb21wbGV0ZSBJQXV0aGVudGljYXRpb25NYW5hZ2VyU2V0dGluZ3NcclxuICAgICAgICB0aGlzLkF1dGhlbnRpY2F0aW9uTWFuYWdlclNldHRpbmdzID0gXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBhdXRob3JpdHk6IGF1dGhlbnRpY2F0aW9uU2V0dGluZ3MuYXV0aG9yaXR5LFxyXG4gICAgICAgICAgICBjbGllbnRfaWQ6IGF1dGhlbnRpY2F0aW9uU2V0dGluZ3MuY2xpZW50X2lkLFxyXG4gICAgICAgICAgICBjbGllbnRfdXJsOiBhdXRoZW50aWNhdGlvblNldHRpbmdzLmNsaWVudF91cmwsXHJcblxyXG4gICAgICAgICAgICBtYXhfcmV0cnlfcmVuZXc6IGF1dGhlbnRpY2F0aW9uU2V0dGluZ3MubWF4X3JldHJ5X3JlbmV3LCBcclxuICAgICAgICAgICAgc2lsZW50X3JlbmV3X3RpbWVvdXQ6IGF1dGhlbnRpY2F0aW9uU2V0dGluZ3Muc2lsZW50X3JlbmV3X3RpbWVvdXQsXHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICByZXNwb25zZV90eXBlOiBhdXRoZW50aWNhdGlvblNldHRpbmdzLnJlc3BvbnNlX3R5cGUsXHJcbiAgICAgICAgICAgIHNjb3BlOiBhdXRoZW50aWNhdGlvblNldHRpbmdzLnNjb3BlLFxyXG5cclxuICAgICAgICAgICAgcGF0dGVybjogYXV0aGVudGljYXRpb25TZXR0aW5ncy5wYXR0ZXJuLFxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgcmVkaXJlY3RfdXJpIDogYXV0aGVudGljYXRpb25TZXR0aW5ncy5jbGllbnRfdXJsLFxyXG4gICAgICAgICAgICBzaWxlbnRfcmVkaXJlY3RfdXJpOiBhdXRoZW50aWNhdGlvblNldHRpbmdzLmNsaWVudF91cmwsXHJcbiAgICAgICAgICAgIHBvc3RfbG9nb3V0X3JlZGlyZWN0X3VyaTogYXV0aGVudGljYXRpb25TZXR0aW5ncy5jbGllbnRfdXJsLFxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgYXV0aG9yaXphdGlvbl91cmwgOiBhdXRoZW50aWNhdGlvblNldHRpbmdzLmF1dGhvcml6YXRpb25fdXJsIHx8IGF1dGhlbnRpY2F0aW9uU2V0dGluZ3MuYXV0aG9yaXR5ICsgXCIvY29ubmVjdC9hdXRob3JpemVcIixcclxuICAgICAgICAgICAgdG9rZW5fdXJsIDogYXV0aGVudGljYXRpb25TZXR0aW5ncy50b2tlbl91cmwgfHwgYXV0aGVudGljYXRpb25TZXR0aW5ncy5hdXRob3JpdHkgKyBcIi9jb25uZWN0L3Rva2VuXCIsXHJcbiAgICAgICAgICAgIHVzZXJpbmZvX3VybDogYXV0aGVudGljYXRpb25TZXR0aW5ncy51c2VyaW5mb191cmwgfHwgYXV0aGVudGljYXRpb25TZXR0aW5ncy5hdXRob3JpdHkgKyBcIi9jb25uZWN0L3VzZXJpbmZvXCIsXHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBsb2FkVXNlckluZm86IHRydWUsXHJcbiAgICAgICAgICAgIGF1dG9tYXRpY1NpbGVudFJlbmV3OiB0cnVlLFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgXHJcbiAgICAgICAgbGV0IHVzZXJNYW5hZ2VyU2V0dGluZ3MgOk9pZGMuVXNlck1hbmFnZXJTZXR0aW5ncyA9IHRoaXMuQXV0aGVudGljYXRpb25NYW5hZ2VyU2V0dGluZ3M7XHJcblxyXG4gICAgICAgIGlmKHRoaXMuQXV0aGVudGljYXRpb25NYW5hZ2VyU2V0dGluZ3MucGF0dGVybiA9PSBQYXR0ZXJuLmNvcmRvdmEpXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnY29yZG92YSBwYXR0ZXJuJyk7XHJcbiAgICAgICAgICAgIHVzZXJNYW5hZ2VyU2V0dGluZ3MucG9wdXBOYXZpZ2F0b3IgPSAoPGFueT5PaWRjKS5Db3Jkb3ZhUG9wdXBOYXZpZ2F0b3IoKTtcclxuICAgICAgICAgICAgdXNlck1hbmFnZXJTZXR0aW5ncy5pZnJhbWVOYXZpZ2F0b3IgPSAoPGFueT5PaWRjKS5Db3Jkb3ZhSUZyYW1lTmF2aWdhdG9yKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLm9pZGNUb2tlbk1hbmFnZXIgPSBuZXcgT2lkYy5Vc2VyTWFuYWdlcih1c2VyTWFuYWdlclNldHRpbmdzKTtcclxuXHJcbiAgICAgICAgLy8gdGhpcy5vaWRjVG9rZW5NYW5hZ2VyLmV2ZW50cy5hZGRVc2VyTG9hZGVkKCgpID0+IHtcclxuICAgICAgICAvLyAgICAgdGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncy5pc19hdXRoZW50aWNhdGVkID0gdHJ1ZTtcclxuICAgICAgICAvLyAgICAgdGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncyA9IHRoaXMuQXV0aGVudGljYXRpb25NYW5hZ2VyU2V0dGluZ3M7XHJcbiAgICAgICAgLy8gfSk7XHJcbiAgICAgICAgLy9SZXRyeSBpbmRlZmluaXRseSBmb3IgcmVuZXdcclxuICAgICAgICAvLyB0aGlzLm9pZGNUb2tlbk1hbmFnZXIuZXZlbnRzLmFkZFNpbGVudFJlbmV3RXJyb3IoKCkgPT4ge1xyXG4gICAgICAgIC8vICAgICBsZXQgY291bnQgPSAxO1xyXG5cclxuICAgICAgICAvLyAgICAgdGhpcy5vaWRjVG9rZW5NYW5hZ2VyLnNpZ25pblNpbGVudCgpO1xyXG5cclxuICAgICAgICAvLyAgICAgbGV0IHN1Y2Nlc3MgPSAoKSA9PiB7XHJcbiAgICAgICAgLy8gICAgICAgICBjb25zb2xlLmRlYnVnKCdSZW5ld2VkIGFmdGVyICcgKyBjb3VudC50b1N0cmluZygpICsgJyBmYWlscyEnKTtcclxuICAgICAgICAvLyAgICAgfTtcclxuICAgICAgICAvLyAgICAgbGV0IGZhaWwgPSAoZXJyb3IpID0+IHtcclxuICAgICAgICAvLyAgICAgICAgIGNvdW50Kys7XHJcbiAgICAgICAgLy8gICAgICAgICBjb25zb2xlLmRlYnVnKCdUb2tlbiBub3QgcmVuZXdlZCEgVHJ5aW5nIGFnYWluIGFmdGVyICcgKyBjb3VudC50b1N0cmluZygpICsgJyBmYWlscyEgTWF4IHJldHJ5IHNldCB0byAnICsgdGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncy5tYXhfcmV0cnlfcmVuZXcgKyAnIScpO1xyXG5cclxuICAgICAgICAvLyAgICAgICAgIGlmKGNvdW50IDwgdGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncy5tYXhfcmV0cnlfcmVuZXcpXHJcbiAgICAgICAgLy8gICAgICAgICB7XHJcbiAgICAgICAgLy8gICAgICAgICAgICAgcmV0dXJuIHRoaXMub2lkY1Rva2VuTWFuYWdlci5yZW5ld1Rva2VuU2lsZW50QXN5bmMoKS50aGVuKHN1Y2Nlc3MsIGZhaWwpO1xyXG4gICAgICAgIC8vICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgLy8gICAgICAgICAgICAgY29uc29sZS5lcnJvcignVG9rZW4gbm90IHJlbmV3ZWQhJyk7XHJcbiAgICAgICAgLy8gICAgICAgICAgICAgdGhpcy5jYWxsYmFja3NUb2tlblJlbmV3RmFpbGVkUmV0cnlNYXguZm9yRWFjaCgoY2FsbGJhY2spPT4ge1xyXG4gICAgICAgIC8vICAgICAgICAgICAgICAgICBjYWxsYmFjaygpO1xyXG4gICAgICAgIC8vICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIC8vICAgICAgICAgICAgIHJldHVybiBwcm9taXNlO1xyXG4gICAgICAgIC8vICAgICAgICAgfVxyXG4gICAgICAgIC8vICAgICB9O1xyXG5cclxuICAgICAgICAvLyAgICAgbGV0IGNoaWxkUHJvbWlzZSA9IHByb21pc2UudGhlbihzdWNjZXNzLCBmYWlsKTtcclxuICAgICAgICAvLyAgICAgcmV0dXJuIGNoaWxkUHJvbWlzZTtcclxuICAgICAgICAvLyB9KTtcclxuXHJcbiAgICAgICAgXHJcbiAgICB9XHJcbiAgICBcclxuXHJcblxyXG5cclxuXHJcbiAgICBwcm90ZWN0ZWQgUHJvY2Vzc1Rva2VuSWZOZWVkZWQoKSA6IFByb21pc2VMaWtlPE9pZGMuVXNlcj5cclxuICAgIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5Jc0F1dGhlbnRpY2F0ZWQudGhlbihpc0F1dGhlbnRpY2F0ZWQgPT4ge1xyXG5cclxuICAgICAgICAgICAgaWYgKGxvY2F0aW9uLmhyZWYuaW5kZXhPZignYWNjZXNzX3Rva2VuPScpID4gLTEgJiYgKGlzQXV0aGVudGljYXRlZCB8fCBsb2NhdGlvbi5ocmVmLmluZGV4T2YoJ3Byb21wdD1ub25lJykgPiAtMSkpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoJ1Byb2Nlc3NpbmcgdG9rZW4hIChzaWxlbnRseSknKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm9pZGNUb2tlbk1hbmFnZXIuc2lnbmluU2lsZW50Q2FsbGJhY2soKTtcclxuICAgICAgICAgICAgfSBlbHNlIFxyXG5cclxuICAgICAgICAgICAgLy9pZiB0aGUgYWN0dWFsIHBhZ2UgaXMgdGhlICdyZWRpcmVjdF91cmknIChsb2FkZWQgZnJvbSB0aGUgbG9jYWxTdG9yYWdlKSwgdGhlbiBpIGNvbnNpZGVyIHRvICdwcm9jZXNzIHRoZSB0b2tlbiBjYWxsYmFjaycgIFxyXG4gICAgICAgICAgICAvL2lmKGxvY2F0aW9uLmhyZWYuc3Vic3RyaW5nKDAsIHRoaXMuQXV0aGVudGljYXRpb25NYW5hZ2VyU2V0dGluZ3MucmVkaXJlY3RfdXJpLmxlbmd0aCkgPT09IHRoaXMuQXV0aGVudGljYXRpb25NYW5hZ2VyU2V0dGluZ3MucmVkaXJlY3RfdXJpKVxyXG4gICAgICAgICAgICBpZihsb2NhdGlvbi5ocmVmLmluZGV4T2YoJ2FjY2Vzc190b2tlbj0nKSA+IC0xKVxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmRlYnVnKCdQcm9jZXNzaW5nIHRva2VuIScpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuUHJvY2Vzc1Rva2VuQ2FsbGJhY2soKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgbGV0IHFQcm9taXNlID0gUS5yZXNvbHZlKG51bGwpO1xyXG4gICAgICAgICAgICByZXR1cm4gcVByb21pc2U7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcblxyXG4gICAgICAgIFxyXG4gICAgICAgIC8vIC8vaWYgdGhlIGFjdHVhbCBwYWdlIGlzIHRoZSAnc2lsZW50X3JlZGlyZWN0X3VyaScgKGxvYWRlZCBmcm9tIHRoZSBsb2NhbFN0b3JhZ2UpLCB0aGVuIGkgY29uc2lkZXIgdG8gJ3Byb2Nlc3MgdGhlIHRva2VuIGNhbGxiYWNrJ1xyXG4gICAgICAgIC8vIGVsc2UgaWYgKGxvY2F0aW9uLmhyZWYuc3Vic3RyaW5nKDAsIHRoaXMuQXV0aGVudGljYXRpb25NYW5hZ2VyU2V0dGluZ3Muc2lsZW50X3JlZGlyZWN0X3VyaS5sZW5ndGgpID09PSB0aGlzLkF1dGhlbnRpY2F0aW9uTWFuYWdlclNldHRpbmdzLnNpbGVudF9yZWRpcmVjdF91cmkpXHJcbiAgICAgICAgLy8ge1xyXG4gICAgICAgIC8vICAgICB0aGlzLlJlbmV3VG9rZW5TaWxlbnQoKTtcclxuICAgICAgICAvLyB9XHJcblxyXG4gICAgfVxyXG4gICAgXHJcbiAgICBwdWJsaWMgSW5pdChhdXRoZW50aWNhdGlvblNldHRpbmdzPzogSUF1dGhlbnRpY2F0aW9uU2V0dGluZ3MpIDogUHJvbWlzZUxpa2U8T2lkYy5Vc2VyPlxyXG4gICAge1xyXG4gICAgICAgIGlmKGF1dGhlbnRpY2F0aW9uU2V0dGluZ3MgIT0gbnVsbClcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHRoaXMuSW5pdGlhbGl6ZShhdXRoZW50aWNhdGlvblNldHRpbmdzKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgcmV0dXJuIHRoaXMuUHJvY2Vzc1Rva2VuSWZOZWVkZWQoKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgcHVibGljIFByb2Nlc3NUb2tlbkNhbGxiYWNrKCkgOiBQcm9taXNlTGlrZTxhbnk+XHJcbiAgICB7XHJcbiAgICAgICAgdGhpcy5WYWxpZGF0ZUluaXRpYWxpemF0aW9uKCk7XHJcbiAgICAgICAgICAgICAgIFxyXG4gICAgICAgIGxldCBwcm9taXNlOiBQcm9taXNlTGlrZTxhbnk+ID0gbnVsbDtcclxuXHJcbiAgICAgICAgaWYodGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncy5vcGVuX29uX3BvcHVwKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgcHJvbWlzZSA9IHRoaXMub2lkY1Rva2VuTWFuYWdlci5zaWduaW5Qb3B1cENhbGxiYWNrKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2VcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHByb21pc2UgPSB0aGlzLm9pZGNUb2tlbk1hbmFnZXIuc2lnbmluUmVkaXJlY3RDYWxsYmFjaygpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IHByb21pc2VSZWRpcmVjdCA9IHByb21pc2VcclxuICAgICAgICAudGhlbihcclxuICAgICAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5SZWRpcmVjdFRvSW5pdGlhbFBhZ2UodGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncy5yZWRpcmVjdF91cmkpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAoZXJyb3IpID0+IHtcclxuICAgICAgICAgICAgICAgIGxldCBtZXNzYWdlID0gXCJQcm9ibGVtIEdldHRpbmcgVG9rZW4gOiBcIiArIChlcnJvci5tZXNzYWdlIHx8IGVycm9yKTtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IobWVzc2FnZSk7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBtZXNzYWdlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHByb21pc2VSZWRpcmVjdDtcclxuICAgIH1cclxuICAgIFxyXG4gICAgLy8gcHVibGljIFJlbmV3VG9rZW5TaWxlbnQoKSA6IFEuSVByb21pc2U8dm9pZD5cclxuICAgIC8vIHtcclxuICAgIC8vICAgICB0aGlzLlZhbGlkYXRlSW5pdGlhbGl6YXRpb24oKTtcclxuICAgICAgICBcclxuICAgIC8vICAgICBsZXQgZGVmZXIgPSBRLmRlZmVyPHZvaWQ+KCk7XHJcbiAgICAvLyAgICAgdGhpcy5vaWRjVG9rZW5NYW5hZ2VyLnJlbmV3VG9rZW5TaWxlbnRBc3luYygpLnRoZW4oXHJcbiAgICAvLyAgICAgICAgICgpID0+IHtcclxuICAgIC8vICAgICAgICAgICAgIGRlZmVyLnJlc29sdmUoKTtcclxuICAgIC8vICAgICAgICAgfSxcclxuICAgIC8vICAgICAgICAgKGVycm9yKSA9PiB7XHJcbiAgICAvLyAgICAgICAgICAgICBsZXQgbWVzc2FnZSA9IFwiUHJvYmxlbSBHZXR0aW5nIFRva2VuIDogXCIgKyAoZXJyb3IubWVzc2FnZSB8fCBlcnJvcik7IFxyXG4gICAgLy8gICAgICAgICAgICAgY29uc29sZS5lcnJvcihtZXNzYWdlKTtcclxuICAgIC8vICAgICAgICAgICAgIGRlZmVyLnJlamVjdChtZXNzYWdlKTtcclxuICAgIC8vICAgICAgICAgfVxyXG4gICAgLy8gICAgICk7XHJcbiAgICAvLyAgICAgcmV0dXJuIGRlZmVyLnByb21pc2U7XHJcbiAgICAvLyB9XHJcbiAgICBcclxuXHJcbiAgICBwcm90ZWN0ZWQgUmVkaXJlY3RUb0luaXRpYWxQYWdlKHVyaSA6c3RyaW5nKVxyXG4gICAge1xyXG4gICAgICAgIGxvY2F0aW9uLmFzc2lnbih1cmkpO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBcclxuICAgIHByb3RlY3RlZCBWYWxpZGF0ZUluaXRpYWxpemF0aW9uKClcclxuICAgIHtcclxuICAgICAgICBpZih0aGlzLkF1dGhlbnRpY2F0aW9uTWFuYWdlclNldHRpbmdzID09IG51bGwpXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICB0aHJvdyBcIkF1dGhlbnRpY2F0aW9uQ29udGV4dCB1bmluaXRpYWxpemVkIVwiO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIFxyXG4gICAgXHJcbiAgICAvKipcclxuICAgICAqIE1ha2UgdGhlIGxvZ2luIGF0IHRoZSBjdXJyZW50IFVSSSwgYW5kIHByb2Nlc3MgdGhlIHJlY2VpdmVkIHRva2Vucy5cclxuICAgICAqIE9CUzogVGhlIFJlZGlyZWN0IFVSSSBbY2FsbGJhY2tfdXJsXSAodG8gcmVjZWl2ZSB0aGUgdG9rZW4pIGFuZCBTaWxlbnQgUmVmcmVzaCBGcmFtZSBVUkkgW3NpbGVudF9yZWRpcmVjdF91cmldICh0byBhdXRvIHJlbmV3IHdoZW4gZXhwaXJlZCkgaWYgbm90IGluZm9ybWVkIGlzIGF1dG8gZ2VuZXJhdGVkIGJhc2VkIG9uIHRoZSAnY2xpZW50X3VybCcgaW5mb3JtZWQgYXQgJ0luaXQnIG1ldGhvZCB3aXRoIHRoZSBmb2xsb3dpbiBzdHJhdGVneTpcclxuICAgICAqIGByZWRpcmVjdF91cmwgPSBjbGllbnRfdXJsICsgJz9jYWxsYmFjaz10cnVlJ2BcclxuICAgICAqIGBzaWxlbnRfcmVkaXJlY3RfdXJpID0gY2xpZW50X3VybCArICc/c2lsZW50cmVmcmVzaGZyYW1lPXRydWUnYCBcclxuICAgICAqIFxyXG4gICAgICogQHBhcmFtIHtib29sZWFufSBbb3Blbk9uUG9wVXBdIChkZXNjcmlwdGlvbilcclxuICAgICAqL1xyXG4gICAgLy8gcHVibGljIExvZ2luQW5kUHJvY2Vzc1Rva2VuKG9wZW5PblBvcFVwPzogYm9vbGVhbilcclxuICAgIC8vIHtcclxuICAgIC8vICAgICB0aGlzLlZhbGlkYXRlSW5pdGlhbGl6YXRpb24oKTtcclxuICAgICAgICBcclxuICAgIC8vICAgICBsZXQgc2hvdWxkT3Blbk9uUG9wVXAgPSBvcGVuT25Qb3BVcCB8fCB0aGlzLkF1dGhlbnRpY2F0aW9uTWFuYWdlclNldHRpbmdzLm9wZW5fb25fcG9wdXA7XHJcbiAgICAgICAgXHJcbiAgICAvLyAgICAgLy9pZiB0aGUgYWN0dWFsIHBhZ2UgaXMgdGhlICdyZWRpcmVjdF91cmknIChsb2FkZWQgZnJvbSB0aGUgbG9jYWxTdG9yYWdlKSwgdGhlbiBpIGNvbnNpZGVyIHRvICdwcm9jZXNzIHRoZSB0b2tlbiBjYWxsYmFjaycgIFxyXG4gICAgLy8gICAgIGlmKGxvY2F0aW9uLmhyZWYuc3Vic3RyaW5nKDAsIHRoaXMuQXV0aGVudGljYXRpb25NYW5hZ2VyU2V0dGluZ3MucmVkaXJlY3RfdXJpLmxlbmd0aCkgPT09IHRoaXMuQXV0aGVudGljYXRpb25NYW5hZ2VyU2V0dGluZ3MucmVkaXJlY3RfdXJpKVxyXG4gICAgLy8gICAgIHtcclxuICAgIC8vICAgICAgICAgdGhpcy5Qcm9jZXNzVG9rZW5DYWxsYmFjaygpO1xyXG4gICAgLy8gICAgIH1cclxuICAgIC8vICAgICAvL2lmIHRoZSBhY3R1YWwgcGFnZSBpcyB0aGUgJ3NpbGVudF9yZWRpcmVjdF91cmknIChsb2FkZWQgZnJvbSB0aGUgbG9jYWxTdG9yYWdlKSwgdGhlbiBpIGNvbnNpZGVyIHRvICdwcm9jZXNzIHRoZSB0b2tlbiBjYWxsYmFjaydcclxuICAgIC8vICAgICBlbHNlIGlmIChsb2NhdGlvbi5ocmVmLnN1YnN0cmluZygwLCB0aGlzLkF1dGhlbnRpY2F0aW9uTWFuYWdlclNldHRpbmdzLnNpbGVudF9yZWRpcmVjdF91cmkubGVuZ3RoKSA9PT0gdGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncy5zaWxlbnRfcmVkaXJlY3RfdXJpKVxyXG4gICAgLy8gICAgIHtcclxuICAgIC8vICAgICAgICAgdGhpcy5SZW5ld1Rva2VuU2lsZW50KCk7XHJcbiAgICAvLyAgICAgfVxyXG4gICAgLy8gICAgIC8vaWYgdGhlIGFjdHVhbCBwYWdlIGlzIHRoZSAnY2xpZW50X3VybCcsIHRoZW4gaSBjb25zaWRlciB0byBtYWtlIHRoZSAnbG9naW4nXHJcbiAgICAvLyAgICAgZWxzZSBpZihsb2NhdGlvbi5ocmVmLnN1YnN0cmluZygwLCB0aGlzLkF1dGhlbnRpY2F0aW9uTWFuYWdlclNldHRpbmdzLmNsaWVudF91cmwubGVuZ3RoKSA9PT0gdGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncy5jbGllbnRfdXJsKVxyXG4gICAgLy8gICAgIHtcclxuICAgIC8vICAgICAgICAgaWYodGhpcy5Jc0F1dGhlbnRpY2F0ZWQgPT09IGZhbHNlKVxyXG4gICAgLy8gICAgICAgICB7XHJcbiAgICAvLyAgICAgICAgICAgICB0aGlzLkxvZ2luKHNob3VsZE9wZW5PblBvcFVwKTtcclxuICAgIC8vICAgICAgICAgfVxyXG4gICAgLy8gICAgIH1cclxuICAgIC8vIH1cclxuICAgIFxyXG4gICAgcHVibGljIExvZ2luKG9wZW5PblBvcFVwPzogYm9vbGVhbikgOiBQcm9taXNlTGlrZTxhbnk+XHJcbiAgICB7XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLklzQXV0aGVudGljYXRlZC50aGVuKChpc0F1dGhlbnRpY2F0ZWQpID0+IHtcclxuXHJcbiAgICAgICAgICAgIGlmKGlzQXV0aGVudGljYXRlZCA9PT0gZmFsc2UpXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuVmFsaWRhdGVJbml0aWFsaXphdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAvL1RPRE86IFRyZWF0IHdoZW4gaW4gbW9iaWxlIGJyb3dzZXIgdG8gbm90IHN1cHBvcnQgcG9wdXBcclxuICAgICAgICAgICAgICAgIGxldCBzaG91bGRPcGVuT25Qb3BVcCA9IG9wZW5PblBvcFVwIHx8IHRoaXMuQXV0aGVudGljYXRpb25NYW5hZ2VyU2V0dGluZ3Mub3Blbl9vbl9wb3B1cDtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgaWYgKHNob3VsZE9wZW5PblBvcFVwKVxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm9pZGNUb2tlbk1hbmFnZXIuc2lnbmluUG9wdXAoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5vaWRjVG9rZW5NYW5hZ2VyLnNpZ25pblJlZGlyZWN0KCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdBbHJlYWR5IGF1dGhlbnRpY2F0ZWQnKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm9pZGNUb2tlbk1hbmFnZXIuZ2V0VXNlcigpLnRoZW4oKHVzZXIpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbGxiYWNrc1Rva2VuT2J0YWluZWQuZm9yRWFjaCgoY2FsbGJhY2spID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sodXNlcik7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldCBJc0F1dGhlbnRpY2F0ZWQoKSA6UHJvbWlzZUxpa2U8Ym9vbGVhbj5cclxuICAgIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5vaWRjVG9rZW5NYW5hZ2VyLmdldFVzZXIoKS50aGVuKHVzZXIgPT4gdXNlciAhPSBudWxsKTtcclxuICAgICAgICBcclxuICAgICAgICAvLyBsZXQgaXNBdXRoZW50aWNhdGVkIDogYm9vbGVhbiA9IGZhbHNlO1xyXG5cclxuICAgICAgICAvLyBpZih0aGlzLkF1dGhlbnRpY2F0aW9uTWFuYWdlclNldHRpbmdzICE9IG51bGwgJiYgdGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncy5pc19hdXRoZW50aWNhdGVkICE9IG51bGwpXHJcbiAgICAgICAgLy8ge1xyXG4gICAgICAgIC8vICAgICBpc0F1dGhlbnRpY2F0ZWQgPSB0aGlzLkF1dGhlbnRpY2F0aW9uTWFuYWdlclNldHRpbmdzLmlzX2F1dGhlbnRpY2F0ZWQ7XHJcbiAgICAgICAgLy8gfVxyXG5cclxuICAgICAgICAvLyByZXR1cm4gaXNBdXRoZW50aWNhdGVkO1xyXG5cclxuXHJcblxyXG4gICAgfVxyXG5cclxuICAgIC8vIHB1YmxpYyBnZXQgVG9rZW5zQ29udGVudHMoKSA6IFRva2Vuc0NvbnRlbnRzXHJcbiAgICAvLyB7XHJcbiAgICAvLyAgICAgbGV0IHRva2VuQ29udGVudHMgPSBuZXcgVG9rZW5zQ29udGVudHMoKTtcclxuICAgICAgICBcclxuICAgIC8vICAgICB0b2tlbkNvbnRlbnRzLkFjY2Vzc1Rva2VuID0gdGhpcy5BY2Nlc3NUb2tlbjtcclxuICAgIC8vICAgICB0b2tlbkNvbnRlbnRzLklkZW50aXR5VG9rZW4gPSB0aGlzLklkZW50aXR5VG9rZW47XHJcbiAgICAgICAgXHJcbiAgICAvLyAgICAgdG9rZW5Db250ZW50cy5BY2Nlc3NUb2tlbkNvbnRlbnQgPSB0aGlzLkFjY2Vzc1Rva2VuQ29udGVudDtcclxuICAgIC8vICAgICB0b2tlbkNvbnRlbnRzLklkZW50aXR5VG9rZW5Db250ZW50ID0gdGhpcy5JZGVudGl0eVRva2VuQ29udGVudDtcclxuICAgIC8vICAgICB0b2tlbkNvbnRlbnRzLlByb2ZpbGVDb250ZW50ID0gdGhpcy5Qcm9maWxlQ29udGVudDtcclxuICAgICAgICBcclxuICAgIC8vICAgICByZXR1cm4gdG9rZW5Db250ZW50cztcclxuICAgIC8vIH1cclxuXHJcbiAgICAvLyBwcm90ZWN0ZWQgZ2V0IEFjY2Vzc1Rva2VuKCk6IHN0cmluZyBcclxuICAgIC8vIHtcclxuICAgIC8vICAgICBpZiAodGhpcy5vaWRjVG9rZW5NYW5hZ2VyICE9IG51bGwpXHJcbiAgICAvLyAgICAge1xyXG4gICAgLy8gICAgICAgICBsZXQgaWRfdG9rZW4gPSB0aGlzLm9pZGNUb2tlbk1hbmFnZXIuYWNjZXNzX3Rva2VuO1xyXG4gICAgLy8gICAgICAgICByZXR1cm4gaWRfdG9rZW47XHJcbiAgICAvLyAgICAgfVxyXG4gICAgLy8gICAgIHJldHVybiBudWxsO1xyXG4gICAgLy8gfVxyXG5cclxuXHJcbiAgICAvLyBwcm90ZWN0ZWQgZ2V0IEFjY2Vzc1Rva2VuQ29udGVudCgpOiBhbnkgXHJcbiAgICAvLyB7XHJcbiAgICAvLyAgICAgaWYodGhpcy5vaWRjVG9rZW5NYW5hZ2VyICE9IG51bGwpXHJcbiAgICAvLyAgICAge1xyXG4gICAgLy8gICAgICAgICBpZih0aGlzLm9pZGNUb2tlbk1hbmFnZXIuYWNjZXNzX3Rva2VuICE9IG51bGwpXHJcbiAgICAvLyAgICAgICAgIHtcclxuICAgIC8vICAgICAgICAgICAgIGxldCBhY2Nlc3NUb2tlbkNvbnRlbnQgPSB0aGlzLm9pZGNUb2tlbk1hbmFnZXIuYWNjZXNzX3Rva2VuLnNwbGl0KCcuJylbMV07XHJcbiAgICAvLyAgICAgICAgICAgICBpZihhY2Nlc3NUb2tlbkNvbnRlbnQgIT0gbnVsbClcclxuICAgIC8vICAgICAgICAgICAgIHtcclxuICAgIC8vICAgICAgICAgICAgICAgICBsZXQgdmFsb3IgPSAgSlNPTi5wYXJzZShhdG9iKGFjY2Vzc1Rva2VuQ29udGVudCkpO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgIHJldHVybiB2YWxvcjtcclxuICAgIC8vICAgICAgICAgICAgIH1cclxuICAgIC8vICAgICAgICAgfVxyXG4gICAgLy8gICAgIH1cclxuICAgIC8vICAgICByZXR1cm4gbnVsbDtcclxuICAgIC8vIH1cclxuICAgIFxyXG4gICAgLy8gcHJvdGVjdGVkIGdldCBJZGVudGl0eVRva2VuKCk6IHN0cmluZyBcclxuICAgIC8vIHtcclxuICAgIC8vICAgICBpZiAodGhpcy5vaWRjVG9rZW5NYW5hZ2VyICE9IG51bGwpXHJcbiAgICAvLyAgICAge1xyXG4gICAgLy8gICAgICAgICBsZXQgaWRfdG9rZW4gPSB0aGlzLm9pZGNUb2tlbk1hbmFnZXIuaWRfdG9rZW47XHJcbiAgICAvLyAgICAgICAgIHJldHVybiBpZF90b2tlbjtcclxuICAgIC8vICAgICB9XHJcbiAgICAvLyAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAvLyB9XHJcblxyXG4gICAgXHJcbiAgICAvLyBwcm90ZWN0ZWQgZ2V0IElkZW50aXR5VG9rZW5Db250ZW50KCk6IGFueVxyXG4gICAgLy8ge1xyXG4gICAgLy8gICAgIGlmKHRoaXMub2lkY1Rva2VuTWFuYWdlciAhPSBudWxsKVxyXG4gICAgLy8gICAgIHtcclxuICAgIC8vICAgICAgICAgaWYodGhpcy5vaWRjVG9rZW5NYW5hZ2VyLmlkX3Rva2VuICE9IG51bGwpXHJcbiAgICAvLyAgICAgICAgIHtcclxuICAgIC8vICAgICAgICAgICAgIGxldCBpZGVudGl0eVRva2VuQ29udGVudCA9IHRoaXMub2lkY1Rva2VuTWFuYWdlci5pZF90b2tlbi5zcGxpdCgnLicpWzFdO1xyXG4gICAgLy8gICAgICAgICAgICAgaWYoaWRlbnRpdHlUb2tlbkNvbnRlbnQgIT0gbnVsbClcclxuICAgIC8vICAgICAgICAgICAgIHtcclxuICAgIC8vICAgICAgICAgICAgICAgICBsZXQgdmFsb3IgPSBKU09OLnBhcnNlKGF0b2IoaWRlbnRpdHlUb2tlbkNvbnRlbnQpKTtcclxuICAgIC8vICAgICAgICAgICAgICAgICByZXR1cm4gdmFsb3I7XHJcbiAgICAvLyAgICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgIH1cclxuICAgIC8vICAgICB9XHJcbiAgICAvLyB9XHJcbiAgICBcclxuICAgIC8vIHByb3RlY3RlZCBnZXQgUHJvZmlsZUNvbnRlbnQoKTogYW55XHJcbiAgICAvLyB7XHJcbiAgICAvLyAgICAgaWYodGhpcy5vaWRjVG9rZW5NYW5hZ2VyICE9IG51bGwpXHJcbiAgICAvLyAgICAge1xyXG4gICAgLy8gICAgICAgICBpZih0aGlzLm9pZGNUb2tlbk1hbmFnZXIucHJvZmlsZSAhPSBudWxsKVxyXG4gICAgLy8gICAgICAgICB7XHJcbiAgICAvLyAgICAgICAgICAgICBsZXQgdmFsb3IgPSB0aGlzLm9pZGNUb2tlbk1hbmFnZXIucHJvZmlsZTtcclxuICAgIC8vICAgICAgICAgICAgIHJldHVybiB2YWxvcjtcclxuICAgIC8vICAgICAgICAgfVxyXG4gICAgLy8gICAgIH1cclxuICAgIC8vICAgICByZXR1cm4gbnVsbDtcclxuICAgIC8vIH1cclxufVxyXG5cclxuLy8gZXhwb3J0IGNsYXNzIFRva2Vuc0NvbnRlbnRzXHJcbi8vIHtcclxuLy8gICAgIHB1YmxpYyBnZXQgSXNBdXRoZW50aWNhdGVkKCkgOmJvb2xlYW5cclxuLy8gICAgIHtcclxuLy8gICAgICAgICBpZih0aGlzLkFjY2Vzc1Rva2VuQ29udGVudCA9PSBudWxsKVxyXG4vLyAgICAgICAgIHtcclxuLy8gICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4vLyAgICAgICAgIH1cclxuLy8gICAgICAgICBlbHNlXHJcbi8vICAgICAgICAge1xyXG4vLyAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuLy8gICAgICAgICB9XHJcbi8vICAgICB9XHJcbiAgICBcclxuLy8gICAgIHByaXZhdGUgX3Byb2ZpbGVDb250ZW50OiBhbnk7XHJcbi8vICAgICBwdWJsaWMgZ2V0IFByb2ZpbGVDb250ZW50KCk6IGFueVxyXG4vLyAgICAge1xyXG4vLyAgICAgICAgIHJldHVybiB0aGlzLl9wcm9maWxlQ29udGVudDtcclxuLy8gICAgIH1cclxuLy8gICAgIHB1YmxpYyBzZXQgUHJvZmlsZUNvbnRlbnQodmFsdWU6IGFueSlcclxuLy8gICAgIHtcclxuLy8gICAgICAgICB0aGlzLl9wcm9maWxlQ29udGVudCA9IHZhbHVlO1xyXG4vLyAgICAgfVxyXG4gICAgXHJcbiAgICBcclxuICAgIFxyXG4vLyAgICAgcHJpdmF0ZSBfYWNjZXNzVG9rZW46IHN0cmluZztcclxuLy8gICAgIHB1YmxpYyBnZXQgQWNjZXNzVG9rZW4oKTogc3RyaW5nXHJcbi8vICAgICB7XHJcbi8vICAgICAgICAgcmV0dXJuIHRoaXMuX2FjY2Vzc1Rva2VuO1xyXG4vLyAgICAgfVxyXG4vLyAgICAgcHVibGljIHNldCBBY2Nlc3NUb2tlbih2YWx1ZTogc3RyaW5nKVxyXG4vLyAgICAge1xyXG4vLyAgICAgICAgIHRoaXMuX2FjY2Vzc1Rva2VuID0gdmFsdWU7XHJcbi8vICAgICB9XHJcbiAgICBcclxuICAgIFxyXG4vLyAgICAgcHJpdmF0ZSBfYWNjZXNzVG9rZW5Db250ZW50OiBhbnk7XHJcbi8vICAgICBwdWJsaWMgZ2V0IEFjY2Vzc1Rva2VuQ29udGVudCgpOiBhbnlcclxuLy8gICAgIHtcclxuLy8gICAgICAgICByZXR1cm4gdGhpcy5fYWNjZXNzVG9rZW5Db250ZW50O1xyXG4vLyAgICAgfVxyXG4vLyAgICAgcHVibGljIHNldCBBY2Nlc3NUb2tlbkNvbnRlbnQodmFsdWU6IGFueSlcclxuLy8gICAgIHtcclxuLy8gICAgICAgICB0aGlzLl9hY2Nlc3NUb2tlbkNvbnRlbnQgPSB2YWx1ZTtcclxuLy8gICAgIH1cclxuICAgIFxyXG4gICAgXHJcbiAgICBcclxuICAgIFxyXG4gICAgXHJcbi8vICAgICBwcml2YXRlIF9pZGVudGl0eVRva2VuOiBzdHJpbmc7XHJcbi8vICAgICBwdWJsaWMgZ2V0IElkZW50aXR5VG9rZW4oKTogc3RyaW5nXHJcbi8vICAgICB7XHJcbi8vICAgICAgICAgcmV0dXJuIHRoaXMuX2lkZW50aXR5VG9rZW47XHJcbi8vICAgICB9XHJcbi8vICAgICBwdWJsaWMgc2V0IElkZW50aXR5VG9rZW4odmFsdWU6IHN0cmluZylcclxuLy8gICAgIHtcclxuLy8gICAgICAgICB0aGlzLl9pZGVudGl0eVRva2VuID0gdmFsdWU7XHJcbi8vICAgICB9XHJcbiAgICBcclxuICAgIFxyXG4vLyAgICAgcHJpdmF0ZSBfaWRlbnRpdHlUb2tlbkNvbnRlbnQ6IGFueTtcclxuLy8gICAgIHB1YmxpYyBnZXQgSWRlbnRpdHlUb2tlbkNvbnRlbnQoKTogYW55XHJcbi8vICAgICB7XHJcbi8vICAgICAgICAgcmV0dXJuIHRoaXMuX2lkZW50aXR5VG9rZW5Db250ZW50O1xyXG4vLyAgICAgfVxyXG4vLyAgICAgcHVibGljIHNldCBJZGVudGl0eVRva2VuQ29udGVudCh2YWx1ZTogYW55KVxyXG4vLyAgICAge1xyXG4vLyAgICAgICAgIHRoaXMuX2lkZW50aXR5VG9rZW5Db250ZW50ID0gdmFsdWU7XHJcbi8vICAgICB9XHJcbiAgICBcclxuICAgIFxyXG4gICAgXHJcbi8vICAgICBwdWJsaWMgdG9rZW5zQ29udGVudHNUb0FycmF5KGluY2x1ZGVFbmNvZGVkVG9rZW5zOmJvb2xlYW4gPSB0cnVlKSA6IEFycmF5PGFueT5cclxuLy8gICAgIHtcclxuLy8gICAgICAgICBsZXQgdG9rZW5zQ29udGVudHMgPSBuZXcgQXJyYXk8YW55PigpO1xyXG5cclxuLy8gICAgICAgICB0b2tlbnNDb250ZW50cy5wdXNoKHRoaXMuSWRlbnRpdHlUb2tlbkNvbnRlbnQpO1xyXG4vLyAgICAgICAgIHRva2Vuc0NvbnRlbnRzLnB1c2godGhpcy5BY2Nlc3NUb2tlbkNvbnRlbnQpO1xyXG4vLyAgICAgICAgIHRva2Vuc0NvbnRlbnRzLnB1c2godGhpcy5Qcm9maWxlQ29udGVudCk7XHJcblxyXG4vLyAgICAgICAgIGlmKGluY2x1ZGVFbmNvZGVkVG9rZW5zKVxyXG4vLyAgICAgICAgIHtcclxuLy8gICAgICAgICAgICAgbGV0IGFjY2Vzc1Rva2VuRW5jb2RlZCA9IHsgJ2FjY2Vzc190b2tlbic6IEF1dGhlbnRpY2F0aW9uQ29udGV4dC5DdXJyZW50LlRva2Vuc0NvbnRlbnRzLkFjY2Vzc1Rva2VuIH07XHJcbi8vICAgICAgICAgICAgIHRva2Vuc0NvbnRlbnRzLnB1c2goYWNjZXNzVG9rZW5FbmNvZGVkKTtcclxuXHJcbi8vICAgICAgICAgICAgIGxldCBpZGVudGl0eVRva2VuRW5jb2RlZCA9IHsgJ2lkX3Rva2VuJzogQXV0aGVudGljYXRpb25Db250ZXh0LkN1cnJlbnQuVG9rZW5zQ29udGVudHMuSWRlbnRpdHlUb2tlbiB9O1xyXG4vLyAgICAgICAgICAgICB0b2tlbnNDb250ZW50cy5wdXNoKGlkZW50aXR5VG9rZW5FbmNvZGVkKTsgXHJcbi8vICAgICAgICAgfVxyXG5cclxuLy8gICAgICAgICByZXR1cm4gdG9rZW5zQ29udGVudHM7XHJcbi8vICAgICB9XHJcbiAgICBcclxuLy8gICAgIHB1YmxpYyBlbmNvZGVkVG9rZW5zVG9BcnJheSgpIDogQXJyYXk8YW55PlxyXG4vLyAgICAge1xyXG4vLyAgICAgICAgIHJldHVybiBbIHRoaXMuSWRlbnRpdHlUb2tlbiwgdGhpcy5BY2Nlc3NUb2tlbiBdO1xyXG4vLyAgICAgfVxyXG4vLyB9XHJcblxyXG4iXX0=
