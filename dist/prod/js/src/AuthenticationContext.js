System.register(['./Pattern', 'oidc-client'], function(exports_1, context_1) {
    "use strict";
    var __moduleName = context_1 && context_1.id;
    var Pattern_1, Oidc;
    var AuthenticationContext;
    return {
        setters:[
            function (Pattern_1_1) {
                Pattern_1 = Pattern_1_1;
            },
            function (Oidc_1) {
                Oidc = Oidc_1;
            }],
        execute: function() {
            AuthenticationContext = (function () {
                function AuthenticationContext() {
                    this.callbacksTokenObtained = new Array();
                    this.callbacksTokenRenewFailedRetryMax = new Array();
                    var authenticationSettingsLoadedFromStorage = this.AuthenticationManagerSettings;
                    if (authenticationSettingsLoadedFromStorage != null) {
                        this.oidcTokenManager = new Oidc.UserManager(authenticationSettingsLoadedFromStorage);
                    }
                }
                Object.defineProperty(AuthenticationContext, "Current", {
                    get: function () {
                        if (AuthenticationContext._current === null) {
                            AuthenticationContext._current = new AuthenticationContext();
                        }
                        return AuthenticationContext._current;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(AuthenticationContext.prototype, "IsInitialized", {
                    get: function () {
                        if (this.AuthenticationManagerSettings != null) {
                            return true;
                        }
                        else {
                            return false;
                        }
                    },
                    enumerable: true,
                    configurable: true
                });
                AuthenticationContext.Reset = function () {
                    AuthenticationContext._current = null;
                };
                AuthenticationContext.prototype.AddOnTokenObtained = function (callback) {
                    this.callbacksTokenObtained.push(callback);
                    this.oidcTokenManager.events.addUserLoaded(callback);
                };
                AuthenticationContext.prototype.AddOnTokenRenewFailedMaxRetry = function (callback) {
                    this.callbacksTokenRenewFailedRetryMax.push(callback);
                };
                Object.defineProperty(AuthenticationContext.prototype, "AuthenticationManagerSettings", {
                    get: function () {
                        var authenticationSettingsFromLocalStorage = null;
                        var authenticationSettingsFromLocalStorageStringify = localStorage.getItem('AuthenticationManagerSettings');
                        if (authenticationSettingsFromLocalStorageStringify != null) {
                            authenticationSettingsFromLocalStorage = JSON.parse(authenticationSettingsFromLocalStorageStringify);
                        }
                        return authenticationSettingsFromLocalStorage;
                    },
                    set: function (value) {
                        localStorage.setItem('AuthenticationManagerSettings', JSON.stringify(value));
                    },
                    enumerable: true,
                    configurable: true
                });
                AuthenticationContext.prototype.Initialize = function (authenticationSettings) {
                    if (authenticationSettings.authority == null || authenticationSettings.client_id == null || authenticationSettings.client_url == null) {
                        throw "Should be informed at least 'authority', 'client_id' and 'client_url'!";
                    }
                    if (authenticationSettings.pattern == null) {
                        authenticationSettings.pattern = Pattern_1.Pattern.none;
                    }
                    authenticationSettings.scope = authenticationSettings.scope || 'openid profile email offline_access';
                    authenticationSettings.response_type = authenticationSettings.response_type || 'code id_token token';
                    authenticationSettings.open_on_popup = authenticationSettings.open_on_popup || false;
                    authenticationSettings.max_retry_renew = authenticationSettings.max_retry_renew || 35;
                    console.debug('Max retry setted to: ' + authenticationSettings.max_retry_renew);
                    authenticationSettings.silent_renew_timeout = authenticationSettings.silent_renew_timeout || 40 * 1000;
                    console.debug('Silent renew timeout setted to: ' + authenticationSettings.silent_renew_timeout + ' miliseconds');
                    var settings = {
                        authority: authenticationSettings.authority,
                        client_id: authenticationSettings.client_id,
                        client_url: authenticationSettings.client_url,
                        max_retry_renew: authenticationSettings.max_retry_renew,
                        silent_renew_timeout: authenticationSettings.silent_renew_timeout,
                        response_type: authenticationSettings.response_type,
                        scope: authenticationSettings.scope,
                        pattern: authenticationSettings.pattern,
                        acr_values: authenticationSettings.acr_values,
                        redirect_uri: authenticationSettings.client_url,
                        silent_redirect_uri: authenticationSettings.client_url,
                        post_logout_redirect_uri: authenticationSettings.client_url,
                        loadUserInfo: true,
                        automaticSilentRenew: true,
                    };
                    console.log('User pattern: ' + Pattern_1.Pattern[settings.pattern]);
                    var pattern = AuthenticationContext.EnvironmentPattern(settings.pattern);
                    console.log('Environment pattern: ' + Pattern_1.Pattern[pattern]);
                    if (pattern == Pattern_1.Pattern.ietf || pattern == Pattern_1.Pattern.nativescript) {
                        console.log('Applying ietf pattern!');
                        settings.client_url = 'urn:ietf:wg:oauth:2.0:oob:auto';
                        settings.redirect_uri = settings.client_url;
                        settings.silent_redirect_uri = settings.client_url;
                        settings.post_logout_redirect_uri = settings.client_url;
                    }
                    if (pattern == Pattern_1.Pattern.electron) {
                        console.log('Applying electron pattern!');
                        settings.open_on_popup = authenticationSettings.open_on_popup || true;
                        settings.popupNavigator = new Oidc.ElectronPopupNavigator();
                        settings.iframeNavigator = new Oidc.ElectronIFrameNavigator();
                    }
                    if (pattern == Pattern_1.Pattern.cordova) {
                        console.log('Applying cordova pattern!');
                        settings.client_url = 'https://localhost/oidc';
                        settings.redirect_uri = settings.client_url;
                        settings.silent_redirect_uri = settings.client_url;
                        settings.post_logout_redirect_uri = settings.client_url;
                        settings.open_on_popup = true;
                        settings.popupNavigator = new Oidc.CordovaPopupNavigator();
                        settings.iframeNavigator = new Oidc.CordovaIFrameNavigator();
                    }
                    this.AuthenticationManagerSettings = settings;
                    var oidcUserManagerSettings = settings;
                    console.log('ClientUrl: ' + oidcUserManagerSettings.redirect_uri);
                    this.oidcTokenManager = new Oidc.UserManager(oidcUserManagerSettings);
                };
                AuthenticationContext.EnvironmentPattern = function (pattern) {
                    if (pattern == Pattern_1.Pattern.auto) {
                        var environment = null;
                        try {
                            environment = window;
                        }
                        catch (error) {
                            console.debug('Should not be an environment with a window global (nativescript/node maybe?)');
                            console.debug(error);
                        }
                        if (environment != null) {
                            if (!!environment.cordova) {
                                pattern = Pattern_1.Pattern.cordova;
                            }
                            else if (environment && environment.process && environment.process.type) {
                                pattern = Pattern_1.Pattern.electron;
                            }
                            else if (environment.location.href.indexOf('file:') > -1) {
                                pattern = Pattern_1.Pattern.ietf;
                            }
                            else {
                                pattern = Pattern_1.Pattern.none;
                            }
                        }
                        else {
                            pattern = Pattern_1.Pattern.nativescript;
                        }
                    }
                    return pattern;
                };
                AuthenticationContext.prototype.ProcessTokenIfNeeded = function () {
                    var _this = this;
                    return this.IsAuthenticated.then(function (isAuthenticated) {
                        if (location.href.indexOf('access_token=') > -1 && (isAuthenticated || location.href.indexOf('prompt=none') > -1)) {
                            console.log('Processing token! (silently)');
                            return _this.oidcTokenManager.signinSilentCallback();
                        }
                        else if (location.href.indexOf('access_token=') > -1) {
                            console.log('Processing token!');
                            return _this.ProcessTokenCallback();
                        }
                        else {
                            return _this.oidcTokenManager.getUser();
                        }
                    });
                };
                AuthenticationContext.prototype.Init = function (authenticationSettings) {
                    if (authenticationSettings != null) {
                        this.Initialize(authenticationSettings);
                    }
                    return this.ProcessTokenIfNeeded();
                };
                AuthenticationContext.prototype.ProcessTokenCallback = function () {
                    this.ValidateInitialization();
                    var settingsPattern = this.AuthenticationManagerSettings.pattern;
                    var pattern = AuthenticationContext.EnvironmentPattern(settingsPattern);
                    var promise = null;
                    var environmentOnlySupportPopup = (pattern == Pattern_1.Pattern.cordova);
                    if (environmentOnlySupportPopup || this.AuthenticationManagerSettings.open_on_popup) {
                        promise = this.oidcTokenManager.signinPopupCallback();
                    }
                    else {
                        promise = this.oidcTokenManager.signinRedirectCallback();
                    }
                    var promiseRedirect = promise
                        .then(function (user) {
                        return user;
                    }, function (error) {
                        var message = "Problem Getting Token : " + (error.message || error);
                        console.error(message);
                        throw message;
                    });
                    return promiseRedirect;
                };
                AuthenticationContext.prototype.RedirectToInitialPage = function (uri) {
                    location.assign(uri);
                };
                AuthenticationContext.prototype.ValidateInitialization = function () {
                    if (this.AuthenticationManagerSettings == null) {
                        throw "AuthenticationContext uninitialized!";
                    }
                };
                AuthenticationContext.prototype.Login = function (openOnPopUp) {
                    var _this = this;
                    return this.IsAuthenticated.then(function (isAuthenticated) {
                        if (isAuthenticated === false) {
                            _this.ValidateInitialization();
                            var settingsPattern = _this.AuthenticationManagerSettings.pattern;
                            var pattern = AuthenticationContext.EnvironmentPattern(settingsPattern);
                            var environmentOnlySupportPopup = (pattern == Pattern_1.Pattern.cordova);
                            var shouldOpenOnPopUp = environmentOnlySupportPopup || (openOnPopUp || _this.AuthenticationManagerSettings.open_on_popup);
                            if (shouldOpenOnPopUp) {
                                var settings = _this.AuthenticationManagerSettings;
                                settings.open_on_popup = true;
                                _this.AuthenticationManagerSettings = settings;
                                return _this.oidcTokenManager.signinPopup();
                            }
                            else {
                                return _this.oidcTokenManager.signinRedirect();
                            }
                        }
                        else {
                            console.warn('Already authenticated');
                            return _this.oidcTokenManager.getUser().then(function (user) {
                                _this.callbacksTokenObtained.forEach(function (callback) {
                                    callback(user);
                                });
                                return user;
                            });
                        }
                    });
                };
                Object.defineProperty(AuthenticationContext.prototype, "IsAuthenticated", {
                    get: function () {
                        return this.oidcTokenManager.getUser().then(function (user) { return user != null; });
                    },
                    enumerable: true,
                    configurable: true
                });
                AuthenticationContext._current = null;
                return AuthenticationContext;
            }());
            exports_1("AuthenticationContext", AuthenticationContext);
        }
    }
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LENBQUMsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQUMsSUFBSTtnQ0FDN0MsS0FBSSxDQUFDLHNCQUFzQixDQUFDLE9BQU8sQ0FBQyxVQUFDLFFBQVE7b0NBQ3pDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQ0FDbkIsQ0FBQyxDQUFDLENBQUM7Z0NBQ0gsTUFBTSxDQUFDLElBQUksQ0FBQzs0QkFDaEIsQ0FBQyxDQUFDLENBQUM7d0JBQ1AsQ0FBQztvQkFFTCxDQUFDLENBQUMsQ0FBQztnQkFHUCxDQUFDO2dCQUVELHNCQUFXLGtEQUFlO3lCQUExQjt3QkFFSSxNQUFNLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFBLElBQUksSUFBSSxPQUFBLElBQUksSUFBSSxJQUFJLEVBQVosQ0FBWSxDQUFDLENBQUM7b0JBYXRFLENBQUM7OzttQkFBQTtnQkFwZGMsOEJBQVEsR0FBMEIsSUFBSSxDQUFDO2dCQXVpQjFELDRCQUFDO1lBQUQsQ0ExaUJBLEFBMGlCQyxJQUFBO1lBMWlCRCx5REEwaUJDLENBQUEiLCJmaWxlIjoiQXV0aGVudGljYXRpb25Db250ZXh0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSUF1dGhlbnRpY2F0aW9uTWFuYWdlclNldHRpbmdzIH0gZnJvbSAnLi9JQXV0aGVudGljYXRpb25NYW5hZ2VyU2V0dGluZ3MnO1xyXG5pbXBvcnQgeyBJQXV0aGVudGljYXRpb25TZXR0aW5ncyB9IGZyb20gJy4vSUF1dGhlbnRpY2F0aW9uU2V0dGluZ3MnO1xyXG5pbXBvcnQgeyBQYXR0ZXJuIH0gZnJvbSAnLi9QYXR0ZXJuJztcclxuXHJcbi8vaW1wb3J0ICogYXMgUSBmcm9tICdxJztcclxuXHJcbmltcG9ydCAqIGFzIE9pZGMgZnJvbSAnb2lkYy1jbGllbnQnO1xyXG5cclxuLy8gZGVjbGFyZSBuYW1lc3BhY2UgT2lkYyB7XHJcbi8vICAgICBleHBvcnQgdmFyIFVzZXIgOiBhbnk7XHJcbi8vICAgICBleHBvcnQgdmFyIFVzZXJNYW5hZ2VyIDogYW55O1xyXG4vLyAgICAgZXhwb3J0IHZhciBVc2VyTWFuYWdlclNldHRpbmdzIDogYW55O1xyXG4vLyB9O1xyXG5cclxuXHJcblxyXG4vKipcclxuICogQXV0aGVudGljYXRpb25Jbml0aWFsaXplclxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIEF1dGhlbnRpY2F0aW9uQ29udGV4dCBcclxue1xyXG4gICAgXHJcbiAgICBwcml2YXRlIHN0YXRpYyBfY3VycmVudDogQXV0aGVudGljYXRpb25Db250ZXh0ID0gbnVsbDtcclxuXHJcbiAgICBwcml2YXRlIGNhbGxiYWNrc1Rva2VuT2J0YWluZWQgOkFycmF5PCh1c2VyOiBPaWRjLlVzZXIpID0+IHZvaWQ+ID0gbmV3IEFycmF5PCh1c2VyOiBPaWRjLlVzZXIpID0+IHZvaWQ+KCk7XHJcblxyXG4gICAgcHJpdmF0ZSBjYWxsYmFja3NUb2tlblJlbmV3RmFpbGVkUmV0cnlNYXggOkFycmF5PCgpID0+IHZvaWQ+ID0gbmV3IEFycmF5PCgpID0+IHZvaWQ+KCk7XHJcblxyXG4gICAgcHVibGljIHN0YXRpYyBnZXQgQ3VycmVudCgpOiBBdXRoZW50aWNhdGlvbkNvbnRleHQgXHJcbiAgICB7XHJcbiAgICAgICAgaWYoQXV0aGVudGljYXRpb25Db250ZXh0Ll9jdXJyZW50ID09PSBudWxsKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgQXV0aGVudGljYXRpb25Db250ZXh0Ll9jdXJyZW50ID0gIG5ldyBBdXRoZW50aWNhdGlvbkNvbnRleHQoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIEF1dGhlbnRpY2F0aW9uQ29udGV4dC5fY3VycmVudDtcclxuICAgIH1cclxuICAgIFxyXG4gICAgcHVibGljIGdldCBJc0luaXRpYWxpemVkKClcclxuICAgIHtcclxuICAgICAgICBpZih0aGlzLkF1dGhlbnRpY2F0aW9uTWFuYWdlclNldHRpbmdzICE9IG51bGwpXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIFxyXG4gICAgcHVibGljIHN0YXRpYyBSZXNldCgpXHJcbiAgICB7XHJcbiAgICAgICAgQXV0aGVudGljYXRpb25Db250ZXh0Ll9jdXJyZW50ID0gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgQWRkT25Ub2tlbk9idGFpbmVkKGNhbGxiYWNrOiAodXNlcjogT2lkYy5Vc2VyKSA9PiB2b2lkKVxyXG4gICAge1xyXG4gICAgICAgIHRoaXMuY2FsbGJhY2tzVG9rZW5PYnRhaW5lZC5wdXNoKGNhbGxiYWNrKTtcclxuICAgICAgICB0aGlzLm9pZGNUb2tlbk1hbmFnZXIuZXZlbnRzLmFkZFVzZXJMb2FkZWQoY2FsbGJhY2spO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBBZGRPblRva2VuUmVuZXdGYWlsZWRNYXhSZXRyeShjYWxsYmFjazogKCkgPT4gdm9pZClcclxuICAgIHtcclxuICAgICAgICB0aGlzLmNhbGxiYWNrc1Rva2VuUmVuZXdGYWlsZWRSZXRyeU1heC5wdXNoKGNhbGxiYWNrKTtcclxuICAgICAgICAvL3RoaXMub2lkY1Rva2VuTWFuYWdlci5hZGRPblNpbGVudFRva2VuUmVuZXdGYWlsZWQoY2FsbGJhY2spO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgb2lkY1Rva2VuTWFuYWdlcjogT2lkYy5Vc2VyTWFuYWdlcjtcclxuICAgICAgICBcclxuICAgIGNvbnN0cnVjdG9yKCkgXHJcbiAgICB7XHJcbiAgICAgICAgbGV0IGF1dGhlbnRpY2F0aW9uU2V0dGluZ3NMb2FkZWRGcm9tU3RvcmFnZSA9IHRoaXMuQXV0aGVudGljYXRpb25NYW5hZ2VyU2V0dGluZ3M7XHJcbiAgICAgICAgaWYoYXV0aGVudGljYXRpb25TZXR0aW5nc0xvYWRlZEZyb21TdG9yYWdlICE9IG51bGwpXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICB0aGlzLm9pZGNUb2tlbk1hbmFnZXIgPSBuZXcgT2lkYy5Vc2VyTWFuYWdlciggYXV0aGVudGljYXRpb25TZXR0aW5nc0xvYWRlZEZyb21TdG9yYWdlICk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgXHJcbiAgICBwcm90ZWN0ZWQgZ2V0IEF1dGhlbnRpY2F0aW9uTWFuYWdlclNldHRpbmdzKCk6IElBdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncyBcclxuICAgIHtcclxuICAgICAgICBsZXQgYXV0aGVudGljYXRpb25TZXR0aW5nc0Zyb21Mb2NhbFN0b3JhZ2U6IElBdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncyA9IG51bGw7XHJcbiAgICAgICAgbGV0IGF1dGhlbnRpY2F0aW9uU2V0dGluZ3NGcm9tTG9jYWxTdG9yYWdlU3RyaW5naWZ5ID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ0F1dGhlbnRpY2F0aW9uTWFuYWdlclNldHRpbmdzJyk7XHJcbiAgICAgICAgaWYoYXV0aGVudGljYXRpb25TZXR0aW5nc0Zyb21Mb2NhbFN0b3JhZ2VTdHJpbmdpZnkgIT0gbnVsbClcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIGF1dGhlbnRpY2F0aW9uU2V0dGluZ3NGcm9tTG9jYWxTdG9yYWdlID0gSlNPTi5wYXJzZShhdXRoZW50aWNhdGlvblNldHRpbmdzRnJvbUxvY2FsU3RvcmFnZVN0cmluZ2lmeSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBhdXRoZW50aWNhdGlvblNldHRpbmdzRnJvbUxvY2FsU3RvcmFnZTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgcHJvdGVjdGVkIHNldCBBdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncyh2YWx1ZTogSUF1dGhlbnRpY2F0aW9uTWFuYWdlclNldHRpbmdzKVxyXG4gICAge1xyXG4gICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdBdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncycsIEpTT04uc3RyaW5naWZ5KHZhbHVlKSk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIHByb3RlY3RlZCBJbml0aWFsaXplKGF1dGhlbnRpY2F0aW9uU2V0dGluZ3M6IElBdXRoZW50aWNhdGlvblNldHRpbmdzKVxyXG4gICAge1xyXG4gICAgICAgIGlmKGF1dGhlbnRpY2F0aW9uU2V0dGluZ3MuYXV0aG9yaXR5ID09IG51bGwgfHwgYXV0aGVudGljYXRpb25TZXR0aW5ncy5jbGllbnRfaWQgPT0gbnVsbCB8fCBhdXRoZW50aWNhdGlvblNldHRpbmdzLmNsaWVudF91cmwgPT0gbnVsbClcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHRocm93IFwiU2hvdWxkIGJlIGluZm9ybWVkIGF0IGxlYXN0ICdhdXRob3JpdHknLCAnY2xpZW50X2lkJyBhbmQgJ2NsaWVudF91cmwnIVwiO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBpZihhdXRoZW50aWNhdGlvblNldHRpbmdzLnBhdHRlcm4gPT0gbnVsbClcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIGF1dGhlbnRpY2F0aW9uU2V0dGluZ3MucGF0dGVybiA9IFBhdHRlcm4ubm9uZTtcclxuICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICBcclxuICAgICAgICAvL1NldCBkZWZhdWx0IHZhbHVlcyBpZiBub3QgaW5mb3JtZWRcclxuICAgICAgICAvL2F1dGhlbnRpY2F0aW9uU2V0dGluZ3MuY2xpZW50X3VybCA9IGF1dGhlbnRpY2F0aW9uU2V0dGluZ3MuY2xpZW50X3VybDsgLy9TZWxmIHVyaVxyXG5cclxuICAgICAgICBhdXRoZW50aWNhdGlvblNldHRpbmdzLnNjb3BlID0gYXV0aGVudGljYXRpb25TZXR0aW5ncy5zY29wZSB8fCAnb3BlbmlkIHByb2ZpbGUgZW1haWwgb2ZmbGluZV9hY2Nlc3MnOyAvL09wZW5JZCBkZWZhdWx0IHNjb3Blc1xyXG4gICAgICAgIGF1dGhlbnRpY2F0aW9uU2V0dGluZ3MucmVzcG9uc2VfdHlwZSA9IGF1dGhlbnRpY2F0aW9uU2V0dGluZ3MucmVzcG9uc2VfdHlwZSB8fCAnY29kZSBpZF90b2tlbiB0b2tlbic7IC8vSHlicmlkIGZsb3cgYXQgZGVmYXVsdFxyXG4gICAgICAgIGF1dGhlbnRpY2F0aW9uU2V0dGluZ3Mub3Blbl9vbl9wb3B1cCA9IGF1dGhlbnRpY2F0aW9uU2V0dGluZ3Mub3Blbl9vbl9wb3B1cCB8fCBmYWxzZTsgLy9SZWRpcmVjdCBmb3IgZGVmYXVsdFxyXG5cclxuICAgICAgICBhdXRoZW50aWNhdGlvblNldHRpbmdzLm1heF9yZXRyeV9yZW5ldyA9IGF1dGhlbnRpY2F0aW9uU2V0dGluZ3MubWF4X3JldHJ5X3JlbmV3IHx8IDM1O1xyXG4gICAgICAgIGNvbnNvbGUuZGVidWcoJ01heCByZXRyeSBzZXR0ZWQgdG86ICcgKyBhdXRoZW50aWNhdGlvblNldHRpbmdzLm1heF9yZXRyeV9yZW5ldyk7XHJcbiAgICAgICAgYXV0aGVudGljYXRpb25TZXR0aW5ncy5zaWxlbnRfcmVuZXdfdGltZW91dCA9IGF1dGhlbnRpY2F0aW9uU2V0dGluZ3Muc2lsZW50X3JlbmV3X3RpbWVvdXQgfHwgNDAgKiAxMDAwOyAvLzQwIHNlY29uZHMgdG8gdGltZW91dFxyXG4gICAgICAgIGNvbnNvbGUuZGVidWcoJ1NpbGVudCByZW5ldyB0aW1lb3V0IHNldHRlZCB0bzogJyArIGF1dGhlbnRpY2F0aW9uU2V0dGluZ3Muc2lsZW50X3JlbmV3X3RpbWVvdXQgKyAnIG1pbGlzZWNvbmRzJyk7XHJcblxyXG4gICAgICAgIFxyXG4gICAgICAgIC8vQ29udmVydCB0byB0aGUgbW9yZSBjb21wbGV0ZSBJQXV0aGVudGljYXRpb25NYW5hZ2VyU2V0dGluZ3NcclxuICAgICAgICBsZXQgc2V0dGluZ3MgOklBdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncyA9IFxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgYXV0aG9yaXR5OiBhdXRoZW50aWNhdGlvblNldHRpbmdzLmF1dGhvcml0eSxcclxuICAgICAgICAgICAgY2xpZW50X2lkOiBhdXRoZW50aWNhdGlvblNldHRpbmdzLmNsaWVudF9pZCxcclxuICAgICAgICAgICAgY2xpZW50X3VybDogYXV0aGVudGljYXRpb25TZXR0aW5ncy5jbGllbnRfdXJsLFxyXG5cclxuICAgICAgICAgICAgbWF4X3JldHJ5X3JlbmV3OiBhdXRoZW50aWNhdGlvblNldHRpbmdzLm1heF9yZXRyeV9yZW5ldywgXHJcbiAgICAgICAgICAgIHNpbGVudF9yZW5ld190aW1lb3V0OiBhdXRoZW50aWNhdGlvblNldHRpbmdzLnNpbGVudF9yZW5ld190aW1lb3V0LFxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgcmVzcG9uc2VfdHlwZTogYXV0aGVudGljYXRpb25TZXR0aW5ncy5yZXNwb25zZV90eXBlLFxyXG4gICAgICAgICAgICBzY29wZTogYXV0aGVudGljYXRpb25TZXR0aW5ncy5zY29wZSxcclxuXHJcbiAgICAgICAgICAgIHBhdHRlcm46IGF1dGhlbnRpY2F0aW9uU2V0dGluZ3MucGF0dGVybixcclxuICAgICAgICAgICAgYWNyX3ZhbHVlczogYXV0aGVudGljYXRpb25TZXR0aW5ncy5hY3JfdmFsdWVzLFxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgcmVkaXJlY3RfdXJpIDogYXV0aGVudGljYXRpb25TZXR0aW5ncy5jbGllbnRfdXJsLFxyXG4gICAgICAgICAgICBzaWxlbnRfcmVkaXJlY3RfdXJpOiBhdXRoZW50aWNhdGlvblNldHRpbmdzLmNsaWVudF91cmwsXHJcbiAgICAgICAgICAgIHBvc3RfbG9nb3V0X3JlZGlyZWN0X3VyaTogYXV0aGVudGljYXRpb25TZXR0aW5ncy5jbGllbnRfdXJsLFxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgLy8gYXV0aG9yaXphdGlvbl91cmwgOiBhdXRoZW50aWNhdGlvblNldHRpbmdzLmF1dGhvcml6YXRpb25fdXJsIHx8IGF1dGhlbnRpY2F0aW9uU2V0dGluZ3MuYXV0aG9yaXR5ICsgXCIvY29ubmVjdC9hdXRob3JpemVcIixcclxuICAgICAgICAgICAgLy8gdG9rZW5fdXJsIDogYXV0aGVudGljYXRpb25TZXR0aW5ncy50b2tlbl91cmwgfHwgYXV0aGVudGljYXRpb25TZXR0aW5ncy5hdXRob3JpdHkgKyBcIi9jb25uZWN0L3Rva2VuXCIsXHJcbiAgICAgICAgICAgIC8vIHVzZXJpbmZvX3VybDogYXV0aGVudGljYXRpb25TZXR0aW5ncy51c2VyaW5mb191cmwgfHwgYXV0aGVudGljYXRpb25TZXR0aW5ncy5hdXRob3JpdHkgKyBcIi9jb25uZWN0L3VzZXJpbmZvXCIsXHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBsb2FkVXNlckluZm86IHRydWUsXHJcbiAgICAgICAgICAgIGF1dG9tYXRpY1NpbGVudFJlbmV3OiB0cnVlLFxyXG4gICAgICAgIH07XHJcblxyXG5cclxuICAgICAgICBjb25zb2xlLmxvZygnVXNlciBwYXR0ZXJuOiAnICsgUGF0dGVybltzZXR0aW5ncy5wYXR0ZXJuXSk7XHJcblxyXG4gICAgICAgIC8vdGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncyA9IHNldHRpbmdzO1xyXG4gICAgICAgIGxldCBwYXR0ZXJuID0gQXV0aGVudGljYXRpb25Db250ZXh0LkVudmlyb25tZW50UGF0dGVybihzZXR0aW5ncy5wYXR0ZXJuKTtcclxuICAgICAgICAvL2xldCBwYXR0ZXJuID0gdGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncy5wYXR0ZXJuO1xyXG4gICAgICAgIFxyXG5cclxuICAgICAgICBjb25zb2xlLmxvZygnRW52aXJvbm1lbnQgcGF0dGVybjogJyArIFBhdHRlcm5bcGF0dGVybl0pO1xyXG5cclxuICAgICAgICBpZihwYXR0ZXJuID09IFBhdHRlcm4uaWV0ZiB8fCBwYXR0ZXJuID09IFBhdHRlcm4ubmF0aXZlc2NyaXB0KVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coJ0FwcGx5aW5nIGlldGYgcGF0dGVybiEnKTtcclxuXHJcbiAgICAgICAgICAgIHNldHRpbmdzLmNsaWVudF91cmwgPSAndXJuOmlldGY6d2c6b2F1dGg6Mi4wOm9vYjphdXRvJztcclxuICAgICAgICAgICAgc2V0dGluZ3MucmVkaXJlY3RfdXJpID0gc2V0dGluZ3MuY2xpZW50X3VybDtcclxuICAgICAgICAgICAgc2V0dGluZ3Muc2lsZW50X3JlZGlyZWN0X3VyaSA9IHNldHRpbmdzLmNsaWVudF91cmw7XHJcbiAgICAgICAgICAgIHNldHRpbmdzLnBvc3RfbG9nb3V0X3JlZGlyZWN0X3VyaSA9IHNldHRpbmdzLmNsaWVudF91cmw7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZihwYXR0ZXJuID09IFBhdHRlcm4uZWxlY3Ryb24pXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnQXBwbHlpbmcgZWxlY3Ryb24gcGF0dGVybiEnKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHNldHRpbmdzLm9wZW5fb25fcG9wdXAgPSBhdXRoZW50aWNhdGlvblNldHRpbmdzLm9wZW5fb25fcG9wdXAgfHwgdHJ1ZTsgLy9MZXQgdGhlIHVzZXIgZm9yY2UgaWYgd2FudGVkXHJcbiAgICAgICAgICAgICg8YW55PnNldHRpbmdzKS5wb3B1cE5hdmlnYXRvciA9IG5ldyAoPGFueT5PaWRjKS5FbGVjdHJvblBvcHVwTmF2aWdhdG9yKCk7XHJcbiAgICAgICAgICAgICg8YW55PnNldHRpbmdzKS5pZnJhbWVOYXZpZ2F0b3IgPSBuZXcgKDxhbnk+T2lkYykuRWxlY3Ryb25JRnJhbWVOYXZpZ2F0b3IoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmKHBhdHRlcm4gPT0gUGF0dGVybi5jb3Jkb3ZhKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coJ0FwcGx5aW5nIGNvcmRvdmEgcGF0dGVybiEnKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHNldHRpbmdzLmNsaWVudF91cmwgPSAnaHR0cHM6Ly9sb2NhbGhvc3Qvb2lkYyc7XHJcbiAgICAgICAgICAgIHNldHRpbmdzLnJlZGlyZWN0X3VyaSA9IHNldHRpbmdzLmNsaWVudF91cmw7XHJcbiAgICAgICAgICAgIHNldHRpbmdzLnNpbGVudF9yZWRpcmVjdF91cmkgPSBzZXR0aW5ncy5jbGllbnRfdXJsO1xyXG4gICAgICAgICAgICBzZXR0aW5ncy5wb3N0X2xvZ291dF9yZWRpcmVjdF91cmkgPSBzZXR0aW5ncy5jbGllbnRfdXJsO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgc2V0dGluZ3Mub3Blbl9vbl9wb3B1cCA9IHRydWU7XHJcbiAgICAgICAgICAgICg8YW55PnNldHRpbmdzKS5wb3B1cE5hdmlnYXRvciA9IG5ldyAoPGFueT5PaWRjKS5Db3Jkb3ZhUG9wdXBOYXZpZ2F0b3IoKTtcclxuICAgICAgICAgICAgKDxhbnk+c2V0dGluZ3MpLmlmcmFtZU5hdmlnYXRvciA9IG5ldyAoPGFueT5PaWRjKS5Db3Jkb3ZhSUZyYW1lTmF2aWdhdG9yKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBcclxuXHJcbiAgICAgICAgdGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncyA9IHNldHRpbmdzO1xyXG5cclxuICAgICAgICBsZXQgb2lkY1VzZXJNYW5hZ2VyU2V0dGluZ3MgOk9pZGMuVXNlck1hbmFnZXJTZXR0aW5ncyA9IHNldHRpbmdzO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnNvbGUubG9nKCdDbGllbnRVcmw6ICcgKyBvaWRjVXNlck1hbmFnZXJTZXR0aW5ncy5yZWRpcmVjdF91cmkpO1xyXG4gICAgICAgIHRoaXMub2lkY1Rva2VuTWFuYWdlciA9IG5ldyBPaWRjLlVzZXJNYW5hZ2VyKG9pZGNVc2VyTWFuYWdlclNldHRpbmdzKTtcclxuXHJcbiAgICAgICAgLy8gdGhpcy5vaWRjVG9rZW5NYW5hZ2VyLmV2ZW50cy5hZGRVc2VyTG9hZGVkKCgpID0+IHtcclxuICAgICAgICAvLyAgICAgdGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncy5pc19hdXRoZW50aWNhdGVkID0gdHJ1ZTtcclxuICAgICAgICAvLyAgICAgdGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncyA9IHRoaXMuQXV0aGVudGljYXRpb25NYW5hZ2VyU2V0dGluZ3M7XHJcbiAgICAgICAgLy8gfSk7XHJcbiAgICAgICAgLy9SZXRyeSBpbmRlZmluaXRseSBmb3IgcmVuZXdcclxuICAgICAgICAvLyB0aGlzLm9pZGNUb2tlbk1hbmFnZXIuZXZlbnRzLmFkZFNpbGVudFJlbmV3RXJyb3IoKCkgPT4ge1xyXG4gICAgICAgIC8vICAgICBsZXQgY291bnQgPSAxO1xyXG5cclxuICAgICAgICAvLyAgICAgdGhpcy5vaWRjVG9rZW5NYW5hZ2VyLnNpZ25pblNpbGVudCgpO1xyXG5cclxuICAgICAgICAvLyAgICAgbGV0IHN1Y2Nlc3MgPSAoKSA9PiB7XHJcbiAgICAgICAgLy8gICAgICAgICBjb25zb2xlLmRlYnVnKCdSZW5ld2VkIGFmdGVyICcgKyBjb3VudC50b1N0cmluZygpICsgJyBmYWlscyEnKTtcclxuICAgICAgICAvLyAgICAgfTtcclxuICAgICAgICAvLyAgICAgbGV0IGZhaWwgPSAoZXJyb3IpID0+IHtcclxuICAgICAgICAvLyAgICAgICAgIGNvdW50Kys7XHJcbiAgICAgICAgLy8gICAgICAgICBjb25zb2xlLmRlYnVnKCdUb2tlbiBub3QgcmVuZXdlZCEgVHJ5aW5nIGFnYWluIGFmdGVyICcgKyBjb3VudC50b1N0cmluZygpICsgJyBmYWlscyEgTWF4IHJldHJ5IHNldCB0byAnICsgdGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncy5tYXhfcmV0cnlfcmVuZXcgKyAnIScpO1xyXG5cclxuICAgICAgICAvLyAgICAgICAgIGlmKGNvdW50IDwgdGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncy5tYXhfcmV0cnlfcmVuZXcpXHJcbiAgICAgICAgLy8gICAgICAgICB7XHJcbiAgICAgICAgLy8gICAgICAgICAgICAgcmV0dXJuIHRoaXMub2lkY1Rva2VuTWFuYWdlci5yZW5ld1Rva2VuU2lsZW50QXN5bmMoKS50aGVuKHN1Y2Nlc3MsIGZhaWwpO1xyXG4gICAgICAgIC8vICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgLy8gICAgICAgICAgICAgY29uc29sZS5lcnJvcignVG9rZW4gbm90IHJlbmV3ZWQhJyk7XHJcbiAgICAgICAgLy8gICAgICAgICAgICAgdGhpcy5jYWxsYmFja3NUb2tlblJlbmV3RmFpbGVkUmV0cnlNYXguZm9yRWFjaCgoY2FsbGJhY2spPT4ge1xyXG4gICAgICAgIC8vICAgICAgICAgICAgICAgICBjYWxsYmFjaygpO1xyXG4gICAgICAgIC8vICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIC8vICAgICAgICAgICAgIHJldHVybiBwcm9taXNlO1xyXG4gICAgICAgIC8vICAgICAgICAgfVxyXG4gICAgICAgIC8vICAgICB9O1xyXG5cclxuICAgICAgICAvLyAgICAgbGV0IGNoaWxkUHJvbWlzZSA9IHByb21pc2UudGhlbihzdWNjZXNzLCBmYWlsKTtcclxuICAgICAgICAvLyAgICAgcmV0dXJuIGNoaWxkUHJvbWlzZTtcclxuICAgICAgICAvLyB9KTtcclxuXHJcbiAgICAgICAgXHJcbiAgICB9XHJcbiAgICBcclxuXHJcbiAgICBwcml2YXRlIHN0YXRpYyBFbnZpcm9ubWVudFBhdHRlcm4ocGF0dGVybjogUGF0dGVybikgOiBQYXR0ZXJuXHJcbiAgICB7XHJcbiAgICAgICAgLy9sZXQgcGF0dGVybiA9IHRoaXMuQXV0aGVudGljYXRpb25NYW5hZ2VyU2V0dGluZ3MucGF0dGVybjtcclxuICAgICAgICBpZihwYXR0ZXJuID09IFBhdHRlcm4uYXV0bylcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIGxldCBlbnZpcm9ubWVudCA6YW55ID0gbnVsbDtcclxuXHJcbiAgICAgICAgICAgIHRyeXtcclxuICAgICAgICAgICAgICAgIGVudmlyb25tZW50ID0gKDxhbnk+d2luZG93KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXRjaChlcnJvcilcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZygnU2hvdWxkIG5vdCBiZSBhbiBlbnZpcm9ubWVudCB3aXRoIGEgd2luZG93IGdsb2JhbCAobmF0aXZlc2NyaXB0L25vZGUgbWF5YmU/KScpO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhlcnJvcik7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmKGVudmlyb25tZW50ICE9IG51bGwpXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIGlmKCEhZW52aXJvbm1lbnQuY29yZG92YSlcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBwYXR0ZXJuID0gUGF0dGVybi5jb3Jkb3ZhO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSBpZihlbnZpcm9ubWVudCAmJiBlbnZpcm9ubWVudC5wcm9jZXNzICYmIGVudmlyb25tZW50LnByb2Nlc3MudHlwZSlcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBwYXR0ZXJuID0gUGF0dGVybi5lbGVjdHJvbjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2UgaWYoKDxXaW5kb3c+ZW52aXJvbm1lbnQpLmxvY2F0aW9uLmhyZWYuaW5kZXhPZignZmlsZTonKSA+IC0xKVxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhdHRlcm4gPSBQYXR0ZXJuLmlldGY7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGF0dGVybiA9IFBhdHRlcm4ubm9uZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIC8vVE9ETzogY2hlY2sgYWdhaW5zdCBub2RlP1xyXG4gICAgICAgICAgICAgICAgcGF0dGVybiA9IFBhdHRlcm4ubmF0aXZlc2NyaXB0O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBwYXR0ZXJuO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBwcm90ZWN0ZWQgUHJvY2Vzc1Rva2VuSWZOZWVkZWQoKSA6IFByb21pc2VMaWtlPE9pZGMuVXNlcj5cclxuICAgIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5Jc0F1dGhlbnRpY2F0ZWQudGhlbihpc0F1dGhlbnRpY2F0ZWQgPT4ge1xyXG5cclxuICAgICAgICAgICAgaWYgKGxvY2F0aW9uLmhyZWYuaW5kZXhPZignYWNjZXNzX3Rva2VuPScpID4gLTEgJiYgKGlzQXV0aGVudGljYXRlZCB8fCBsb2NhdGlvbi5ocmVmLmluZGV4T2YoJ3Byb21wdD1ub25lJykgPiAtMSkpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdQcm9jZXNzaW5nIHRva2VuISAoc2lsZW50bHkpJyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5vaWRjVG9rZW5NYW5hZ2VyLnNpZ25pblNpbGVudENhbGxiYWNrKCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBcclxuXHJcbiAgICAgICAgICAgIC8vaWYgdGhlIGFjdHVhbCBwYWdlIGlzIHRoZSAncmVkaXJlY3RfdXJpJyAobG9hZGVkIGZyb20gdGhlIGxvY2FsU3RvcmFnZSksIHRoZW4gaSBjb25zaWRlciB0byAncHJvY2VzcyB0aGUgdG9rZW4gY2FsbGJhY2snICBcclxuICAgICAgICAgICAgLy9pZihsb2NhdGlvbi5ocmVmLnN1YnN0cmluZygwLCB0aGlzLkF1dGhlbnRpY2F0aW9uTWFuYWdlclNldHRpbmdzLnJlZGlyZWN0X3VyaS5sZW5ndGgpID09PSB0aGlzLkF1dGhlbnRpY2F0aW9uTWFuYWdlclNldHRpbmdzLnJlZGlyZWN0X3VyaSlcclxuICAgICAgICAgICAgaWYobG9jYXRpb24uaHJlZi5pbmRleE9mKCdhY2Nlc3NfdG9rZW49JykgPiAtMSlcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1Byb2Nlc3NpbmcgdG9rZW4hJyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5Qcm9jZXNzVG9rZW5DYWxsYmFjaygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMub2lkY1Rva2VuTWFuYWdlci5nZXRVc2VyKCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG5cclxuICAgICAgICBcclxuICAgICAgICAvLyAvL2lmIHRoZSBhY3R1YWwgcGFnZSBpcyB0aGUgJ3NpbGVudF9yZWRpcmVjdF91cmknIChsb2FkZWQgZnJvbSB0aGUgbG9jYWxTdG9yYWdlKSwgdGhlbiBpIGNvbnNpZGVyIHRvICdwcm9jZXNzIHRoZSB0b2tlbiBjYWxsYmFjaydcclxuICAgICAgICAvLyBlbHNlIGlmIChsb2NhdGlvbi5ocmVmLnN1YnN0cmluZygwLCB0aGlzLkF1dGhlbnRpY2F0aW9uTWFuYWdlclNldHRpbmdzLnNpbGVudF9yZWRpcmVjdF91cmkubGVuZ3RoKSA9PT0gdGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncy5zaWxlbnRfcmVkaXJlY3RfdXJpKVxyXG4gICAgICAgIC8vIHtcclxuICAgICAgICAvLyAgICAgdGhpcy5SZW5ld1Rva2VuU2lsZW50KCk7XHJcbiAgICAgICAgLy8gfVxyXG5cclxuICAgIH1cclxuICAgIFxyXG4gICAgcHVibGljIEluaXQoYXV0aGVudGljYXRpb25TZXR0aW5ncz86IElBdXRoZW50aWNhdGlvblNldHRpbmdzKSA6IFByb21pc2VMaWtlPE9pZGMuVXNlcj5cclxuICAgIHtcclxuICAgICAgICBpZihhdXRoZW50aWNhdGlvblNldHRpbmdzICE9IG51bGwpXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICB0aGlzLkluaXRpYWxpemUoYXV0aGVudGljYXRpb25TZXR0aW5ncyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIHJldHVybiB0aGlzLlByb2Nlc3NUb2tlbklmTmVlZGVkKCk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIHB1YmxpYyBQcm9jZXNzVG9rZW5DYWxsYmFjaygpIDogUHJvbWlzZUxpa2U8YW55PlxyXG4gICAge1xyXG4gICAgICAgIHRoaXMuVmFsaWRhdGVJbml0aWFsaXphdGlvbigpO1xyXG5cclxuICAgICAgICBsZXQgc2V0dGluZ3NQYXR0ZXJuID0gdGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncy5wYXR0ZXJuO1xyXG4gICAgICAgIGxldCBwYXR0ZXJuID0gQXV0aGVudGljYXRpb25Db250ZXh0LkVudmlyb25tZW50UGF0dGVybihzZXR0aW5nc1BhdHRlcm4pO1xyXG5cclxuICAgICAgICBsZXQgcHJvbWlzZTogUHJvbWlzZUxpa2U8YW55PiA9IG51bGw7XHJcblxyXG4gICAgICAgIGxldCBlbnZpcm9ubWVudE9ubHlTdXBwb3J0UG9wdXA6IGJvb2xlYW4gPSAocGF0dGVybiA9PSBQYXR0ZXJuLmNvcmRvdmEpO1xyXG4gICAgICAgIGlmKGVudmlyb25tZW50T25seVN1cHBvcnRQb3B1cCB8fCB0aGlzLkF1dGhlbnRpY2F0aW9uTWFuYWdlclNldHRpbmdzLm9wZW5fb25fcG9wdXApXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBwcm9taXNlID0gdGhpcy5vaWRjVG9rZW5NYW5hZ2VyLnNpZ25pblBvcHVwQ2FsbGJhY2soKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgcHJvbWlzZSA9IHRoaXMub2lkY1Rva2VuTWFuYWdlci5zaWduaW5SZWRpcmVjdENhbGxiYWNrKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgcHJvbWlzZVJlZGlyZWN0ID0gcHJvbWlzZVxyXG4gICAgICAgIC50aGVuKFxyXG4gICAgICAgICAgICAodXNlcikgPT4ge1xyXG4gICAgICAgICAgICAgICAgLy90aGlzLlJlZGlyZWN0VG9Jbml0aWFsUGFnZSh0aGlzLkF1dGhlbnRpY2F0aW9uTWFuYWdlclNldHRpbmdzLnJlZGlyZWN0X3VyaSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdXNlcjtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgKGVycm9yKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBsZXQgbWVzc2FnZSA9IFwiUHJvYmxlbSBHZXR0aW5nIFRva2VuIDogXCIgKyAoZXJyb3IubWVzc2FnZSB8fCBlcnJvcik7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKG1lc3NhZ2UpO1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbWVzc2FnZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICk7XHJcblxyXG4gICAgICAgIHJldHVybiBwcm9taXNlUmVkaXJlY3Q7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIC8vIHB1YmxpYyBSZW5ld1Rva2VuU2lsZW50KCkgOiBRLklQcm9taXNlPHZvaWQ+XHJcbiAgICAvLyB7XHJcbiAgICAvLyAgICAgdGhpcy5WYWxpZGF0ZUluaXRpYWxpemF0aW9uKCk7XHJcbiAgICAgICAgXHJcbiAgICAvLyAgICAgbGV0IGRlZmVyID0gUS5kZWZlcjx2b2lkPigpO1xyXG4gICAgLy8gICAgIHRoaXMub2lkY1Rva2VuTWFuYWdlci5yZW5ld1Rva2VuU2lsZW50QXN5bmMoKS50aGVuKFxyXG4gICAgLy8gICAgICAgICAoKSA9PiB7XHJcbiAgICAvLyAgICAgICAgICAgICBkZWZlci5yZXNvbHZlKCk7XHJcbiAgICAvLyAgICAgICAgIH0sXHJcbiAgICAvLyAgICAgICAgIChlcnJvcikgPT4ge1xyXG4gICAgLy8gICAgICAgICAgICAgbGV0IG1lc3NhZ2UgPSBcIlByb2JsZW0gR2V0dGluZyBUb2tlbiA6IFwiICsgKGVycm9yLm1lc3NhZ2UgfHwgZXJyb3IpOyBcclxuICAgIC8vICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IobWVzc2FnZSk7XHJcbiAgICAvLyAgICAgICAgICAgICBkZWZlci5yZWplY3QobWVzc2FnZSk7XHJcbiAgICAvLyAgICAgICAgIH1cclxuICAgIC8vICAgICApO1xyXG4gICAgLy8gICAgIHJldHVybiBkZWZlci5wcm9taXNlO1xyXG4gICAgLy8gfVxyXG4gICAgXHJcblxyXG4gICAgcHJvdGVjdGVkIFJlZGlyZWN0VG9Jbml0aWFsUGFnZSh1cmkgOnN0cmluZylcclxuICAgIHtcclxuICAgICAgICBsb2NhdGlvbi5hc3NpZ24odXJpKTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgXHJcbiAgICBwcm90ZWN0ZWQgVmFsaWRhdGVJbml0aWFsaXphdGlvbigpXHJcbiAgICB7XHJcbiAgICAgICAgaWYodGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncyA9PSBudWxsKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgdGhyb3cgXCJBdXRoZW50aWNhdGlvbkNvbnRleHQgdW5pbml0aWFsaXplZCFcIjtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBcclxuICAgIFxyXG4gICAgLyoqXHJcbiAgICAgKiBNYWtlIHRoZSBsb2dpbiBhdCB0aGUgY3VycmVudCBVUkksIGFuZCBwcm9jZXNzIHRoZSByZWNlaXZlZCB0b2tlbnMuXHJcbiAgICAgKiBPQlM6IFRoZSBSZWRpcmVjdCBVUkkgW2NhbGxiYWNrX3VybF0gKHRvIHJlY2VpdmUgdGhlIHRva2VuKSBhbmQgU2lsZW50IFJlZnJlc2ggRnJhbWUgVVJJIFtzaWxlbnRfcmVkaXJlY3RfdXJpXSAodG8gYXV0byByZW5ldyB3aGVuIGV4cGlyZWQpIGlmIG5vdCBpbmZvcm1lZCBpcyBhdXRvIGdlbmVyYXRlZCBiYXNlZCBvbiB0aGUgJ2NsaWVudF91cmwnIGluZm9ybWVkIGF0ICdJbml0JyBtZXRob2Qgd2l0aCB0aGUgZm9sbG93aW4gc3RyYXRlZ3k6XHJcbiAgICAgKiBgcmVkaXJlY3RfdXJsID0gY2xpZW50X3VybCArICc/Y2FsbGJhY2s9dHJ1ZSdgXHJcbiAgICAgKiBgc2lsZW50X3JlZGlyZWN0X3VyaSA9IGNsaWVudF91cmwgKyAnP3NpbGVudHJlZnJlc2hmcmFtZT10cnVlJ2AgXHJcbiAgICAgKiBcclxuICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW29wZW5PblBvcFVwXSAoZGVzY3JpcHRpb24pXHJcbiAgICAgKi9cclxuICAgIC8vIHB1YmxpYyBMb2dpbkFuZFByb2Nlc3NUb2tlbihvcGVuT25Qb3BVcD86IGJvb2xlYW4pXHJcbiAgICAvLyB7XHJcbiAgICAvLyAgICAgdGhpcy5WYWxpZGF0ZUluaXRpYWxpemF0aW9uKCk7XHJcbiAgICAgICAgXHJcbiAgICAvLyAgICAgbGV0IHNob3VsZE9wZW5PblBvcFVwID0gb3Blbk9uUG9wVXAgfHwgdGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncy5vcGVuX29uX3BvcHVwO1xyXG4gICAgICAgIFxyXG4gICAgLy8gICAgIC8vaWYgdGhlIGFjdHVhbCBwYWdlIGlzIHRoZSAncmVkaXJlY3RfdXJpJyAobG9hZGVkIGZyb20gdGhlIGxvY2FsU3RvcmFnZSksIHRoZW4gaSBjb25zaWRlciB0byAncHJvY2VzcyB0aGUgdG9rZW4gY2FsbGJhY2snICBcclxuICAgIC8vICAgICBpZihsb2NhdGlvbi5ocmVmLnN1YnN0cmluZygwLCB0aGlzLkF1dGhlbnRpY2F0aW9uTWFuYWdlclNldHRpbmdzLnJlZGlyZWN0X3VyaS5sZW5ndGgpID09PSB0aGlzLkF1dGhlbnRpY2F0aW9uTWFuYWdlclNldHRpbmdzLnJlZGlyZWN0X3VyaSlcclxuICAgIC8vICAgICB7XHJcbiAgICAvLyAgICAgICAgIHRoaXMuUHJvY2Vzc1Rva2VuQ2FsbGJhY2soKTtcclxuICAgIC8vICAgICB9XHJcbiAgICAvLyAgICAgLy9pZiB0aGUgYWN0dWFsIHBhZ2UgaXMgdGhlICdzaWxlbnRfcmVkaXJlY3RfdXJpJyAobG9hZGVkIGZyb20gdGhlIGxvY2FsU3RvcmFnZSksIHRoZW4gaSBjb25zaWRlciB0byAncHJvY2VzcyB0aGUgdG9rZW4gY2FsbGJhY2snXHJcbiAgICAvLyAgICAgZWxzZSBpZiAobG9jYXRpb24uaHJlZi5zdWJzdHJpbmcoMCwgdGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncy5zaWxlbnRfcmVkaXJlY3RfdXJpLmxlbmd0aCkgPT09IHRoaXMuQXV0aGVudGljYXRpb25NYW5hZ2VyU2V0dGluZ3Muc2lsZW50X3JlZGlyZWN0X3VyaSlcclxuICAgIC8vICAgICB7XHJcbiAgICAvLyAgICAgICAgIHRoaXMuUmVuZXdUb2tlblNpbGVudCgpO1xyXG4gICAgLy8gICAgIH1cclxuICAgIC8vICAgICAvL2lmIHRoZSBhY3R1YWwgcGFnZSBpcyB0aGUgJ2NsaWVudF91cmwnLCB0aGVuIGkgY29uc2lkZXIgdG8gbWFrZSB0aGUgJ2xvZ2luJ1xyXG4gICAgLy8gICAgIGVsc2UgaWYobG9jYXRpb24uaHJlZi5zdWJzdHJpbmcoMCwgdGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncy5jbGllbnRfdXJsLmxlbmd0aCkgPT09IHRoaXMuQXV0aGVudGljYXRpb25NYW5hZ2VyU2V0dGluZ3MuY2xpZW50X3VybClcclxuICAgIC8vICAgICB7XHJcbiAgICAvLyAgICAgICAgIGlmKHRoaXMuSXNBdXRoZW50aWNhdGVkID09PSBmYWxzZSlcclxuICAgIC8vICAgICAgICAge1xyXG4gICAgLy8gICAgICAgICAgICAgdGhpcy5Mb2dpbihzaG91bGRPcGVuT25Qb3BVcCk7XHJcbiAgICAvLyAgICAgICAgIH1cclxuICAgIC8vICAgICB9XHJcbiAgICAvLyB9XHJcbiAgICBcclxuICAgIHB1YmxpYyBMb2dpbihvcGVuT25Qb3BVcD86IGJvb2xlYW4pIDogUHJvbWlzZUxpa2U8YW55PlxyXG4gICAge1xyXG5cclxuICAgICAgICByZXR1cm4gdGhpcy5Jc0F1dGhlbnRpY2F0ZWQudGhlbigoaXNBdXRoZW50aWNhdGVkKSA9PiB7XHJcblxyXG4gICAgICAgICAgICBpZihpc0F1dGhlbnRpY2F0ZWQgPT09IGZhbHNlKVxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLlZhbGlkYXRlSW5pdGlhbGl6YXRpb24oKTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgLy9UT0RPOiBUcmVhdCB3aGVuIGluIG1vYmlsZSBicm93c2VyIHRvIG5vdCBzdXBwb3J0IHBvcHVwXHJcbiAgICAgICAgICAgICAgICBsZXQgc2V0dGluZ3NQYXR0ZXJuID0gdGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncy5wYXR0ZXJuO1xyXG4gICAgICAgICAgICAgICAgbGV0IHBhdHRlcm4gPSBBdXRoZW50aWNhdGlvbkNvbnRleHQuRW52aXJvbm1lbnRQYXR0ZXJuKHNldHRpbmdzUGF0dGVybik7XHJcbiAgICAgICAgICAgICAgICBsZXQgZW52aXJvbm1lbnRPbmx5U3VwcG9ydFBvcHVwOiBib29sZWFuID0gKHBhdHRlcm4gPT0gUGF0dGVybi5jb3Jkb3ZhKTtcclxuICAgICAgICAgICAgICAgIGxldCBzaG91bGRPcGVuT25Qb3BVcCA9IGVudmlyb25tZW50T25seVN1cHBvcnRQb3B1cCB8fCAob3Blbk9uUG9wVXAgfHwgdGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncy5vcGVuX29uX3BvcHVwKTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgaWYgKHNob3VsZE9wZW5PblBvcFVwKVxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBzZXR0aW5ncyA9IHRoaXMuQXV0aGVudGljYXRpb25NYW5hZ2VyU2V0dGluZ3M7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3Mub3Blbl9vbl9wb3B1cCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncyA9IHNldHRpbmdzO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5vaWRjVG9rZW5NYW5hZ2VyLnNpZ25pblBvcHVwKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMub2lkY1Rva2VuTWFuYWdlci5zaWduaW5SZWRpcmVjdCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignQWxyZWFkeSBhdXRoZW50aWNhdGVkJyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5vaWRjVG9rZW5NYW5hZ2VyLmdldFVzZXIoKS50aGVuKCh1c2VyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYWxsYmFja3NUb2tlbk9idGFpbmVkLmZvckVhY2goKGNhbGxiYWNrKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHVzZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB1c2VyO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcblxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXQgSXNBdXRoZW50aWNhdGVkKCkgOlByb21pc2VMaWtlPGJvb2xlYW4+XHJcbiAgICB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMub2lkY1Rva2VuTWFuYWdlci5nZXRVc2VyKCkudGhlbih1c2VyID0+IHVzZXIgIT0gbnVsbCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8gbGV0IGlzQXV0aGVudGljYXRlZCA6IGJvb2xlYW4gPSBmYWxzZTtcclxuXHJcbiAgICAgICAgLy8gaWYodGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncyAhPSBudWxsICYmIHRoaXMuQXV0aGVudGljYXRpb25NYW5hZ2VyU2V0dGluZ3MuaXNfYXV0aGVudGljYXRlZCAhPSBudWxsKVxyXG4gICAgICAgIC8vIHtcclxuICAgICAgICAvLyAgICAgaXNBdXRoZW50aWNhdGVkID0gdGhpcy5BdXRoZW50aWNhdGlvbk1hbmFnZXJTZXR0aW5ncy5pc19hdXRoZW50aWNhdGVkO1xyXG4gICAgICAgIC8vIH1cclxuXHJcbiAgICAgICAgLy8gcmV0dXJuIGlzQXV0aGVudGljYXRlZDtcclxuXHJcblxyXG5cclxuICAgIH1cclxuXHJcbiAgICAvLyBwdWJsaWMgZ2V0IFRva2Vuc0NvbnRlbnRzKCkgOiBUb2tlbnNDb250ZW50c1xyXG4gICAgLy8ge1xyXG4gICAgLy8gICAgIGxldCB0b2tlbkNvbnRlbnRzID0gbmV3IFRva2Vuc0NvbnRlbnRzKCk7XHJcbiAgICAgICAgXHJcbiAgICAvLyAgICAgdG9rZW5Db250ZW50cy5BY2Nlc3NUb2tlbiA9IHRoaXMuQWNjZXNzVG9rZW47XHJcbiAgICAvLyAgICAgdG9rZW5Db250ZW50cy5JZGVudGl0eVRva2VuID0gdGhpcy5JZGVudGl0eVRva2VuO1xyXG4gICAgICAgIFxyXG4gICAgLy8gICAgIHRva2VuQ29udGVudHMuQWNjZXNzVG9rZW5Db250ZW50ID0gdGhpcy5BY2Nlc3NUb2tlbkNvbnRlbnQ7XHJcbiAgICAvLyAgICAgdG9rZW5Db250ZW50cy5JZGVudGl0eVRva2VuQ29udGVudCA9IHRoaXMuSWRlbnRpdHlUb2tlbkNvbnRlbnQ7XHJcbiAgICAvLyAgICAgdG9rZW5Db250ZW50cy5Qcm9maWxlQ29udGVudCA9IHRoaXMuUHJvZmlsZUNvbnRlbnQ7XHJcbiAgICAgICAgXHJcbiAgICAvLyAgICAgcmV0dXJuIHRva2VuQ29udGVudHM7XHJcbiAgICAvLyB9XHJcblxyXG4gICAgLy8gcHJvdGVjdGVkIGdldCBBY2Nlc3NUb2tlbigpOiBzdHJpbmcgXHJcbiAgICAvLyB7XHJcbiAgICAvLyAgICAgaWYgKHRoaXMub2lkY1Rva2VuTWFuYWdlciAhPSBudWxsKVxyXG4gICAgLy8gICAgIHtcclxuICAgIC8vICAgICAgICAgbGV0IGlkX3Rva2VuID0gdGhpcy5vaWRjVG9rZW5NYW5hZ2VyLmFjY2Vzc190b2tlbjtcclxuICAgIC8vICAgICAgICAgcmV0dXJuIGlkX3Rva2VuO1xyXG4gICAgLy8gICAgIH1cclxuICAgIC8vICAgICByZXR1cm4gbnVsbDtcclxuICAgIC8vIH1cclxuXHJcblxyXG4gICAgLy8gcHJvdGVjdGVkIGdldCBBY2Nlc3NUb2tlbkNvbnRlbnQoKTogYW55IFxyXG4gICAgLy8ge1xyXG4gICAgLy8gICAgIGlmKHRoaXMub2lkY1Rva2VuTWFuYWdlciAhPSBudWxsKVxyXG4gICAgLy8gICAgIHtcclxuICAgIC8vICAgICAgICAgaWYodGhpcy5vaWRjVG9rZW5NYW5hZ2VyLmFjY2Vzc190b2tlbiAhPSBudWxsKVxyXG4gICAgLy8gICAgICAgICB7XHJcbiAgICAvLyAgICAgICAgICAgICBsZXQgYWNjZXNzVG9rZW5Db250ZW50ID0gdGhpcy5vaWRjVG9rZW5NYW5hZ2VyLmFjY2Vzc190b2tlbi5zcGxpdCgnLicpWzFdO1xyXG4gICAgLy8gICAgICAgICAgICAgaWYoYWNjZXNzVG9rZW5Db250ZW50ICE9IG51bGwpXHJcbiAgICAvLyAgICAgICAgICAgICB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgbGV0IHZhbG9yID0gIEpTT04ucGFyc2UoYXRvYihhY2Nlc3NUb2tlbkNvbnRlbnQpKTtcclxuICAgIC8vICAgICAgICAgICAgICAgICByZXR1cm4gdmFsb3I7XHJcbiAgICAvLyAgICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgIH1cclxuICAgIC8vICAgICB9XHJcbiAgICAvLyAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAvLyB9XHJcbiAgICBcclxuICAgIC8vIHByb3RlY3RlZCBnZXQgSWRlbnRpdHlUb2tlbigpOiBzdHJpbmcgXHJcbiAgICAvLyB7XHJcbiAgICAvLyAgICAgaWYgKHRoaXMub2lkY1Rva2VuTWFuYWdlciAhPSBudWxsKVxyXG4gICAgLy8gICAgIHtcclxuICAgIC8vICAgICAgICAgbGV0IGlkX3Rva2VuID0gdGhpcy5vaWRjVG9rZW5NYW5hZ2VyLmlkX3Rva2VuO1xyXG4gICAgLy8gICAgICAgICByZXR1cm4gaWRfdG9rZW47XHJcbiAgICAvLyAgICAgfVxyXG4gICAgLy8gICAgIHJldHVybiBudWxsO1xyXG4gICAgLy8gfVxyXG5cclxuICAgIFxyXG4gICAgLy8gcHJvdGVjdGVkIGdldCBJZGVudGl0eVRva2VuQ29udGVudCgpOiBhbnlcclxuICAgIC8vIHtcclxuICAgIC8vICAgICBpZih0aGlzLm9pZGNUb2tlbk1hbmFnZXIgIT0gbnVsbClcclxuICAgIC8vICAgICB7XHJcbiAgICAvLyAgICAgICAgIGlmKHRoaXMub2lkY1Rva2VuTWFuYWdlci5pZF90b2tlbiAhPSBudWxsKVxyXG4gICAgLy8gICAgICAgICB7XHJcbiAgICAvLyAgICAgICAgICAgICBsZXQgaWRlbnRpdHlUb2tlbkNvbnRlbnQgPSB0aGlzLm9pZGNUb2tlbk1hbmFnZXIuaWRfdG9rZW4uc3BsaXQoJy4nKVsxXTtcclxuICAgIC8vICAgICAgICAgICAgIGlmKGlkZW50aXR5VG9rZW5Db250ZW50ICE9IG51bGwpXHJcbiAgICAvLyAgICAgICAgICAgICB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgbGV0IHZhbG9yID0gSlNPTi5wYXJzZShhdG9iKGlkZW50aXR5VG9rZW5Db250ZW50KSk7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbG9yO1xyXG4gICAgLy8gICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgICB9XHJcbiAgICAvLyAgICAgfVxyXG4gICAgLy8gfVxyXG4gICAgXHJcbiAgICAvLyBwcm90ZWN0ZWQgZ2V0IFByb2ZpbGVDb250ZW50KCk6IGFueVxyXG4gICAgLy8ge1xyXG4gICAgLy8gICAgIGlmKHRoaXMub2lkY1Rva2VuTWFuYWdlciAhPSBudWxsKVxyXG4gICAgLy8gICAgIHtcclxuICAgIC8vICAgICAgICAgaWYodGhpcy5vaWRjVG9rZW5NYW5hZ2VyLnByb2ZpbGUgIT0gbnVsbClcclxuICAgIC8vICAgICAgICAge1xyXG4gICAgLy8gICAgICAgICAgICAgbGV0IHZhbG9yID0gdGhpcy5vaWRjVG9rZW5NYW5hZ2VyLnByb2ZpbGU7XHJcbiAgICAvLyAgICAgICAgICAgICByZXR1cm4gdmFsb3I7XHJcbiAgICAvLyAgICAgICAgIH1cclxuICAgIC8vICAgICB9XHJcbiAgICAvLyAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAvLyB9XHJcbn1cclxuXHJcbi8vIGV4cG9ydCBjbGFzcyBUb2tlbnNDb250ZW50c1xyXG4vLyB7XHJcbi8vICAgICBwdWJsaWMgZ2V0IElzQXV0aGVudGljYXRlZCgpIDpib29sZWFuXHJcbi8vICAgICB7XHJcbi8vICAgICAgICAgaWYodGhpcy5BY2Nlc3NUb2tlbkNvbnRlbnQgPT0gbnVsbClcclxuLy8gICAgICAgICB7XHJcbi8vICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuLy8gICAgICAgICB9XHJcbi8vICAgICAgICAgZWxzZVxyXG4vLyAgICAgICAgIHtcclxuLy8gICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbi8vICAgICAgICAgfVxyXG4vLyAgICAgfVxyXG4gICAgXHJcbi8vICAgICBwcml2YXRlIF9wcm9maWxlQ29udGVudDogYW55O1xyXG4vLyAgICAgcHVibGljIGdldCBQcm9maWxlQ29udGVudCgpOiBhbnlcclxuLy8gICAgIHtcclxuLy8gICAgICAgICByZXR1cm4gdGhpcy5fcHJvZmlsZUNvbnRlbnQ7XHJcbi8vICAgICB9XHJcbi8vICAgICBwdWJsaWMgc2V0IFByb2ZpbGVDb250ZW50KHZhbHVlOiBhbnkpXHJcbi8vICAgICB7XHJcbi8vICAgICAgICAgdGhpcy5fcHJvZmlsZUNvbnRlbnQgPSB2YWx1ZTtcclxuLy8gICAgIH1cclxuICAgIFxyXG4gICAgXHJcbiAgICBcclxuLy8gICAgIHByaXZhdGUgX2FjY2Vzc1Rva2VuOiBzdHJpbmc7XHJcbi8vICAgICBwdWJsaWMgZ2V0IEFjY2Vzc1Rva2VuKCk6IHN0cmluZ1xyXG4vLyAgICAge1xyXG4vLyAgICAgICAgIHJldHVybiB0aGlzLl9hY2Nlc3NUb2tlbjtcclxuLy8gICAgIH1cclxuLy8gICAgIHB1YmxpYyBzZXQgQWNjZXNzVG9rZW4odmFsdWU6IHN0cmluZylcclxuLy8gICAgIHtcclxuLy8gICAgICAgICB0aGlzLl9hY2Nlc3NUb2tlbiA9IHZhbHVlO1xyXG4vLyAgICAgfVxyXG4gICAgXHJcbiAgICBcclxuLy8gICAgIHByaXZhdGUgX2FjY2Vzc1Rva2VuQ29udGVudDogYW55O1xyXG4vLyAgICAgcHVibGljIGdldCBBY2Nlc3NUb2tlbkNvbnRlbnQoKTogYW55XHJcbi8vICAgICB7XHJcbi8vICAgICAgICAgcmV0dXJuIHRoaXMuX2FjY2Vzc1Rva2VuQ29udGVudDtcclxuLy8gICAgIH1cclxuLy8gICAgIHB1YmxpYyBzZXQgQWNjZXNzVG9rZW5Db250ZW50KHZhbHVlOiBhbnkpXHJcbi8vICAgICB7XHJcbi8vICAgICAgICAgdGhpcy5fYWNjZXNzVG9rZW5Db250ZW50ID0gdmFsdWU7XHJcbi8vICAgICB9XHJcbiAgICBcclxuICAgIFxyXG4gICAgXHJcbiAgICBcclxuICAgIFxyXG4vLyAgICAgcHJpdmF0ZSBfaWRlbnRpdHlUb2tlbjogc3RyaW5nO1xyXG4vLyAgICAgcHVibGljIGdldCBJZGVudGl0eVRva2VuKCk6IHN0cmluZ1xyXG4vLyAgICAge1xyXG4vLyAgICAgICAgIHJldHVybiB0aGlzLl9pZGVudGl0eVRva2VuO1xyXG4vLyAgICAgfVxyXG4vLyAgICAgcHVibGljIHNldCBJZGVudGl0eVRva2VuKHZhbHVlOiBzdHJpbmcpXHJcbi8vICAgICB7XHJcbi8vICAgICAgICAgdGhpcy5faWRlbnRpdHlUb2tlbiA9IHZhbHVlO1xyXG4vLyAgICAgfVxyXG4gICAgXHJcbiAgICBcclxuLy8gICAgIHByaXZhdGUgX2lkZW50aXR5VG9rZW5Db250ZW50OiBhbnk7XHJcbi8vICAgICBwdWJsaWMgZ2V0IElkZW50aXR5VG9rZW5Db250ZW50KCk6IGFueVxyXG4vLyAgICAge1xyXG4vLyAgICAgICAgIHJldHVybiB0aGlzLl9pZGVudGl0eVRva2VuQ29udGVudDtcclxuLy8gICAgIH1cclxuLy8gICAgIHB1YmxpYyBzZXQgSWRlbnRpdHlUb2tlbkNvbnRlbnQodmFsdWU6IGFueSlcclxuLy8gICAgIHtcclxuLy8gICAgICAgICB0aGlzLl9pZGVudGl0eVRva2VuQ29udGVudCA9IHZhbHVlO1xyXG4vLyAgICAgfVxyXG4gICAgXHJcbiAgICBcclxuICAgIFxyXG4vLyAgICAgcHVibGljIHRva2Vuc0NvbnRlbnRzVG9BcnJheShpbmNsdWRlRW5jb2RlZFRva2Vuczpib29sZWFuID0gdHJ1ZSkgOiBBcnJheTxhbnk+XHJcbi8vICAgICB7XHJcbi8vICAgICAgICAgbGV0IHRva2Vuc0NvbnRlbnRzID0gbmV3IEFycmF5PGFueT4oKTtcclxuXHJcbi8vICAgICAgICAgdG9rZW5zQ29udGVudHMucHVzaCh0aGlzLklkZW50aXR5VG9rZW5Db250ZW50KTtcclxuLy8gICAgICAgICB0b2tlbnNDb250ZW50cy5wdXNoKHRoaXMuQWNjZXNzVG9rZW5Db250ZW50KTtcclxuLy8gICAgICAgICB0b2tlbnNDb250ZW50cy5wdXNoKHRoaXMuUHJvZmlsZUNvbnRlbnQpO1xyXG5cclxuLy8gICAgICAgICBpZihpbmNsdWRlRW5jb2RlZFRva2VucylcclxuLy8gICAgICAgICB7XHJcbi8vICAgICAgICAgICAgIGxldCBhY2Nlc3NUb2tlbkVuY29kZWQgPSB7ICdhY2Nlc3NfdG9rZW4nOiBBdXRoZW50aWNhdGlvbkNvbnRleHQuQ3VycmVudC5Ub2tlbnNDb250ZW50cy5BY2Nlc3NUb2tlbiB9O1xyXG4vLyAgICAgICAgICAgICB0b2tlbnNDb250ZW50cy5wdXNoKGFjY2Vzc1Rva2VuRW5jb2RlZCk7XHJcblxyXG4vLyAgICAgICAgICAgICBsZXQgaWRlbnRpdHlUb2tlbkVuY29kZWQgPSB7ICdpZF90b2tlbic6IEF1dGhlbnRpY2F0aW9uQ29udGV4dC5DdXJyZW50LlRva2Vuc0NvbnRlbnRzLklkZW50aXR5VG9rZW4gfTtcclxuLy8gICAgICAgICAgICAgdG9rZW5zQ29udGVudHMucHVzaChpZGVudGl0eVRva2VuRW5jb2RlZCk7IFxyXG4vLyAgICAgICAgIH1cclxuXHJcbi8vICAgICAgICAgcmV0dXJuIHRva2Vuc0NvbnRlbnRzO1xyXG4vLyAgICAgfVxyXG4gICAgXHJcbi8vICAgICBwdWJsaWMgZW5jb2RlZFRva2Vuc1RvQXJyYXkoKSA6IEFycmF5PGFueT5cclxuLy8gICAgIHtcclxuLy8gICAgICAgICByZXR1cm4gWyB0aGlzLklkZW50aXR5VG9rZW4sIHRoaXMuQWNjZXNzVG9rZW4gXTtcclxuLy8gICAgIH1cclxuLy8gfVxyXG5cclxuIl19
